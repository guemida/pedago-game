<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ CybersÃ©curitÃ© â€” Challenge Terminal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { height: 100%; width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
   
    <script type="text/babel" data-presets="react">


/*- ------------------ */ 



// â”€â”€â”€ RANDOMIZATION HELPERS â”€â”€â”€
const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);
const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

const caesarShift = (text, shift) => {
  let result = "";
  for (let c of text.toUpperCase()) {
    if (c >= "A" && c <= "Z") {
      result += String.fromCharCode(((c.charCodeAt(0) - 65 + shift + 26) % 26) + 65);
    } else {
      result += c;
    }
  }
  return result;
};

// â”€â”€â”€ LEVEL GENERATORS (randomized each game) â”€â”€â”€

const generateScanLevel = () => {
  const targets = [
    { ip: "192.168.1.42", ports: "22,8080", type: "SERVER" },
    { ip: "10.0.0.17", ports: "22,443,3306", type: "DATABASE" },
    { ip: "172.16.0.99", ports: "21,22,80", type: "WEB SERVER" },
  ];
  const target = pick(targets);
  const decoys = shuffle([
    { ip: "192.168.1.1", ports: "80,443", type: "ROUTER" },
    { ip: "192.168.1.10", ports: "22,80", type: "PRINTER" },
    { ip: "10.0.0.1", ports: "53,80", type: "DNS" },
    { ip: "172.16.0.1", ports: "80,443", type: "GATEWAY" },
    { ip: "192.168.1.25", ports: "554", type: "CAMERA" },
    { ip: "10.0.0.50", ports: "25,587", type: "MAIL" },
  ]).slice(0, 3);

  return {
    id: "scan",
    title: "RECONNAISSANCE",
    mission: "Scannez le rÃ©seau pour identifier la cible vulnÃ©rable. Tapez 'help' pour les commandes.",
    hint: `Tapez 'scan' puis connectez-vous Ã  la cible marquÃ©e VULNÃ‰RABLE.`,
    topic: "Scan rÃ©seau & Reconnaissance",
    targetIp: target.ip,
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘           COMMANDES DISPONIBLES              â•‘",
          "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
          "â•‘  scan            - Scanner le rÃ©seau         â•‘",
          "â•‘  connect <ip>    - Se connecter Ã  une cible  â•‘",
          "â•‘  nmap <ip>       - DÃ©tail des ports          â•‘",
          "â•‘  mission / hint / score                      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      scan: {
        response: [
          `âŸ³ Scanning rÃ©seau...`,
          ...decoys.map(
            (d) => `  â”œâ”€ ${d.ip.padEnd(16)} [${d.type}]${"".padEnd(10 - d.type.length)}Port ${d.ports}`
          ),
          `  â””â”€ ${target.ip.padEnd(16)} [${target.type}]${"".padEnd(10 - target.type.length)}Port ${target.ports} âš  VULNÃ‰RABLE`,
          "",
          `â†’ Cible dÃ©tectÃ©e ! Tapez 'connect ${target.ip}'`,
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("connect ")) {
        const ip = input.slice(8).trim();
        if (ip === target.ip) return null;
        return [`âœ— Connexion refusÃ©e Ã  ${ip}. Ce n'est pas la bonne cible.`];
      }
      if (input.startsWith("nmap ")) {
        const ip = input.slice(5).trim();
        const all = [...decoys, target];
        const found = all.find((d) => d.ip === ip);
        if (found) {
          const vuln = found === target ? " âš  VULNÃ‰RABLE" : "";
          return [`NMAP ${ip}:`, `  Type: ${found.type}`, `  Ports ouverts: ${found.ports}${vuln}`];
        }
        return [`âœ— HÃ´te ${ip} non trouvÃ©.`];
      }
      return null;
    },
    checkWin: (input) => input === `connect ${target.ip}`,
    winResponse: [
      `âœ“ Connexion Ã©tablie avec ${target.ip}`,
      "",
      "âš  LEÃ‡ON : La reconnaissance est la 1Ã¨re Ã©tape d'un pentest.",
      "â†’ Outils rÃ©els : Nmap, Masscan, Shodan.",
      "â†’ DÃ©fense : fermer les ports inutiles, IDS/IPS.",
    ],
  };
};

const generateBruteForceLevel = (difficulty) => {
  const passwords = {
    "dÃ©butant": [
      { pass: "admin", hint: "C'est le login par dÃ©faut le plus courant." },
      { pass: "password", hint: "Le mot de passe le plus utilisÃ© au monde." },
      { pass: "123456", hint: "La suite de chiffres la plus Ã©vidente." },
    ],
    "intermÃ©diaire": [
      { pass: "root", hint: "Compte superutilisateur Linux." },
      { pass: "toor", hint: "Root Ã  l'envers â€” courant sur les distros de pentest." },
      { pass: "changeme", hint: "Message souvent laissÃ© comme password par dÃ©faut." },
    ],
    "expert": [
      { pass: "P@ssw0rd", hint: "Le classique avec substitutions Ã©videntes (leet speak basique)." },
      { pass: "Welcome1", hint: "Souvent utilisÃ© comme password initial en entreprise." },
      { pass: "Summer2024", hint: "Pattern saisonnier+annÃ©e, trÃ¨s courant en entreprise." },
    ],
  };

  const pool = passwords[difficulty];
  const chosen = pick(pool);
  const maxAttempts = difficulty === "dÃ©butant" ? 10 : difficulty === "intermÃ©diaire" ? 7 : 5;
  let attempts = 0;

  const commonPasswords = shuffle([
    "123456", "password", "admin", "root", "qwerty", "letmein", "welcome",
    "monkey", "dragon", "master", "abc123", "111111", "toor", "changeme",
    "P@ssw0rd", "Welcome1", "Summer2024", "Winter2023", "Company1", "Azerty1",
  ]);

  return {
    id: "bruteforce",
    title: "BRUTE FORCE",
    mission: `Le serveur demande un mot de passe. Vous avez ${maxAttempts} tentatives. Testez avec 'try <password>'. Tapez 'wordlist' pour une liste.`,
    hint: chosen.hint,
    topic: "Mots de passe faibles & Brute force",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  try <mdp>     - Tester un mot de passe      â•‘",
          "â•‘  wordlist      - Passwords courants           â•‘",
          "â•‘  attempts      - Tentatives restantes         â•‘",
          "â•‘  explain       - En savoir plus               â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      wordlist: {
        response: [
          "ğŸ“‹ Passwords frÃ©quents :",
          ...commonPasswords.slice(0, 12).map((p, i) => `  ${(i + 1).toString().padStart(2)}. ${p}`),
          "",
          `âš  En 2024, 80% des breaches impliquent des mots de passe faibles.`,
        ],
      },
      explain: {
        response: [
          "ğŸ“– BRUTE FORCE",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "Tester systÃ©matiquement tous les mots de passe possibles.",
          "",
          "Variantes :",
          "  â€¢ Dictionnaire : tester une liste de mots courants",
          "  â€¢ Hybride : mots + variations (Password1, P@ssw0rd...)",
          "  â€¢ Pur : toutes les combinaisons (lent mais exhaustif)",
          "",
          `Outils rÃ©els : Hydra, John the Ripper, Hashcat.`,
          `DÃ©fense : rate limiting, 2FA, passwords 12+ caractÃ¨res.`,
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("try ")) {
        const guess = input.slice(4).trim();
        attempts++;
        if (guess === chosen.pass) return null;
        const remaining = maxAttempts - attempts;
        if (remaining <= 0) {
          attempts = 0;
          return [
            `âœ— AccÃ¨s refusÃ©. Plus de tentatives !`,
            `â†’ Le mot de passe Ã©tait : ${chosen.pass}`,
            `â†’ Compteur rÃ©initialisÃ©, rÃ©essayez.`,
          ];
        }
        return [`âœ— AccÃ¨s refusÃ©. (${remaining} tentatives restantes)`];
      }
      if (input === "attempts") {
        return [`Tentatives restantes : ${maxAttempts - attempts}/${maxAttempts}`];
      }
      if (input === "retry") {
        attempts = 0;
        return [`âŸ³ Compteur rÃ©initialisÃ©. ${maxAttempts} tentatives disponibles.`];
      }
      return null;
    },
    checkWin: (input) => input.startsWith("try ") && input.slice(4).trim() === chosen.pass,
    winResponse: [
      `âœ“ ACCÃˆS AUTORISÃ‰ ! Password crackÃ© : "${chosen.pass}"`,
      `  TrouvÃ© en ${attempts + 1} tentative(s).`,
      "",
      "âš  LEÃ‡ON :",
      "â†’ Ne jamais utiliser de passwords par dÃ©faut ou prÃ©visibles.",
      "â†’ Minimum 12 caractÃ¨res, mÃ©lange majuscules/minuscules/chiffres/symboles.",
      "â†’ Utiliser un gestionnaire de mots de passe (Bitwarden, KeePass).",
      "â†’ Activer le 2FA partout oÃ¹ c'est possible.",
    ],
  };
};

const generateCaesarLevel = (difficulty) => {
  const messages = {
    "dÃ©butant": ["ATTAQUE A MIDI", "MOT DE PASSE FRAGILE", "ALERTE SECURITE"],
    "intermÃ©diaire": ["RENDEZ VOUS AU SERVEUR NORD", "TRANSFERT DE DONNEES EN COURS", "CLEF COMPROMISE CHANGER URGENT"],
    "expert": ["EXTRACTION FICHIER CONFIDENTIEL CONFIRME", "PROTOCOLE EVACUATION ACTIVE CODE ROUGE", "AGENT DOUBLE IDENTIFIE SECTEUR SEPT"],
  };

  const shifts = { "dÃ©butant": [3, 5], "intermÃ©diaire": [7, 11, 13], "expert": [17, 19, 23] };

  const plaintext = pick(messages[difficulty]);
  const shift = pick(shifts[difficulty]);
  const ciphertext = caesarShift(plaintext, shift);

  return {
    id: "caesar",
    title: "CHIFFREMENT CÃ‰SAR",
    mission: `Message interceptÃ© : '${ciphertext}'. DÃ©calage inconnu. Utilisez 'caesar <texte> <dÃ©calage>' pour tester.`,
    hint:
      difficulty === "dÃ©butant"
        ? `Essayez les petits dÃ©calages nÃ©gatifs. Testez: caesar ${ciphertext} -${shift}`
        : `Il y a 25 dÃ©calages possibles. Utilisez 'bruteforce caesar' pour tous les tester.`,
    topic: "Cryptographie â€” Chiffrement de CÃ©sar",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  caesar <texte> <n>   - Appliquer dÃ©calage   â•‘",
          "â•‘  bruteforce caesar    - Tester les 25 shifts  â•‘",
          "â•‘  explain              - Comprendre CÃ©sar      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      "bruteforce caesar": {
        response: [
          `âŸ³ Test des 25 dÃ©calages sur '${ciphertext.slice(0, 20)}${ciphertext.length > 20 ? "..." : ""}' :`,
          "",
          ...Array.from({ length: 25 }, (_, i) => {
            const s = -(i + 1);
            const result = caesarShift(ciphertext, s);
            const marker = result === plaintext ? " â—„â—„â—„ LISIBLE !" : "";
            return `  ROT ${String(s).padStart(3)} â†’ ${result.slice(0, 40)}${result.length > 40 ? "..." : ""}${marker}`;
          }),
          "",
          "â†’ RepÃ©rez le texte lisible et validez avec caesar !",
        ],
      },
      explain: {
        response: [
          "ğŸ“– CHIFFREMENT DE CÃ‰SAR",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "Chaque lettre dÃ©calÃ©e de N positions dans l'alphabet.",
          `Exemple ROT+3 : Aâ†’D, Bâ†’E, ... Zâ†’C`,
          "",
          "Faiblesse : seulement 25 clÃ©s possibles.",
          "SystÃ¨mes modernes : AES-256 (2Â²âµâ¶ clÃ©s possibles).",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("caesar ")) {
        const parts = input.split(" ");
        const sh = parseInt(parts[parts.length - 1]);
        if (isNaN(sh)) return ["âœ— Format: caesar <texte> <dÃ©calage>"];
        const text = parts.slice(1, -1).join(" ").toUpperCase();
        const result = caesarShift(text, sh);
        if (result === plaintext) return null;
        return [`â†’ ${result}`, "", "Pas le bon dÃ©calage..."];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("caesar ")) return false;
      const parts = input.split(" ");
      const sh = parseInt(parts[parts.length - 1]);
      if (isNaN(sh)) return false;
      const text = parts.slice(1, -1).join(" ").toUpperCase();
      return caesarShift(text, sh) === plaintext;
    },
    winResponse: [
      `âœ“ MESSAGE DÃ‰CHIFFRÃ‰ : ${plaintext}`,
      `  DÃ©calage utilisÃ© : ${shift}`,
      "",
      "âš  LEÃ‡ON :",
      "â†’ CÃ©sar est cassable en secondes (25 possibilitÃ©s).",
      "â†’ L'analyse de frÃ©quence casse aussi les substitutions simples.",
      "â†’ Le chiffrement moderne utilise des clÃ©s de 128-256 bits.",
    ],
  };
};

const generateBase64Level = (difficulty) => {
  const secrets = {
    "dÃ©butant": ["Serveur Secret", "Admin Panel", "Root Access"],
    "intermÃ©diaire": ["mysql://admin:tiger@db.internal:3306", "api_key=sk-9f8e7d6c5b4a3210", "ssh-rsa AAAAB3NzaC1yc2EA"],
    "expert": [
      '{"user":"admin","role":"superadmin","token":"x7k9m2"}',
      "password_hash=5f4dcc3b5aa765d61d8327deb882cf99",
    ],
  };

  const secret = pick(secrets[difficulty]);
  const encoded = btoa(secret);

  return {
    id: "base64",
    title: "ENCODAGE BASE64",
    mission: `DonnÃ©es suspectes interceptÃ©es : '${encoded}'. DÃ©codez-les avec 'decode <texte>'.`,
    hint: `Base64 se termine souvent par = ou ==. Tapez: decode ${encoded}`,
    topic: "Encodage vs Chiffrement",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  decode <texte>    - DÃ©coder du Base64        â•‘",
          "â•‘  encode <texte>    - Encoder en Base64        â•‘",
          "â•‘  explain           - Comprendre Base64        â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– BASE64",
          "â”â”â”â”â”â”â”â”â”",
          "Convertit des donnÃ©es binaires en texte ASCII (A-Z, a-z, 0-9, +, /).",
          "",
          "âš  CE N'EST PAS DU CHIFFREMENT !",
          "â†’ Pas de clÃ©, pas de secret. Tout le monde peut dÃ©coder.",
          "â†’ On le trouve partout : emails, JWT tokens, images inline.",
          "",
          "Erreur courante : stocker des passwords en Base64.",
          "â†’ Utiliser bcrypt, Argon2 ou scrypt pour le hachage.",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("decode ")) {
        const b64 = input.slice(7).trim();
        try {
          const decoded = atob(b64);
          if (decoded === secret) return null;
          return [`â†’ DÃ©codÃ© : ${decoded}`];
        } catch {
          return ["âœ— Texte Base64 invalide. VÃ©rifiez la chaÃ®ne."];
        }
      }
      if (input.startsWith("encode ")) {
        const text = input.slice(7).trim();
        return [`â†’ EncodÃ© : ${btoa(text)}`];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("decode ")) return false;
      try {
        return atob(input.slice(7).trim()) === secret;
      } catch {
        return false;
      }
    },
    winResponse: [
      `âœ“ DONNÃ‰ES DÃ‰CODÃ‰ES : ${secret}`,
      "",
      "âš  LEÃ‡ON :",
      "â†’ Base64 = encodage RÃ‰VERSIBLE sans clÃ©.",
      "â†’ Ne JAMAIS l'utiliser pour protÃ©ger des donnÃ©es sensibles.",
      difficulty !== "dÃ©butant" ? "â†’ En pentest, toujours checker les headers/cookies/tokens pour du Base64." : "â†’ Utiliser du vrai chiffrement (AES) ou du hachage (bcrypt).",
    ],
  };
};

const generateSQLiLevel = (difficulty) => {
  const scenarios = {
    "intermÃ©diaire": {
      table: "users",
      query: "SELECT * FROM users WHERE username='{INPUT}' AND password='{PASS}'",
      hint: "Terminez le username avec une quote et un commentaire SQL : admin' --",
    },
    "expert": {
      table: "accounts",
      query: "SELECT * FROM accounts WHERE login='{INPUT}' AND token=SHA256('{PASS}')",
      hint: "MÃªme avec du hachage cÃ´tÃ© requÃªte, l'injection sur le login fonctionne : admin' UNION SELECT * FROM accounts --",
    },
  };

  const sc = scenarios[difficulty] || scenarios["intermÃ©diaire"];

  return {
    id: "sqli",
    title: "INJECTION SQL",
    mission: `Formulaire de login (table: ${sc.table}). Exploitez la faille SQL avec 'login <user> <pass>'.`,
    hint: sc.hint,
    topic: "Injection SQL (OWASP #1)",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  login <user> <pass> - Tenter une connexion   â•‘",
          "â•‘  view query          - Voir la requÃªte SQL    â•‘",
          "â•‘  explain             - Comprendre SQLi        â•‘",
          "â•‘  tables              - Lister les tables      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      "view query": {
        response: [`ğŸ“‹ RequÃªte SQL :`, "", `  ${sc.query}`, "", "â†’ Que se passe-t-il si vous injectez une quote (') ?"],
      },
      tables: {
        response: [`Tables : ${sc.table} (id, username/login, password, role)`, `         sessions (id, user_id, token)`, `         logs (id, action, timestamp)`],
      },
      explain: {
        response: [
          "ğŸ“– INJECTION SQL",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "Manipuler les requÃªtes SQL via les champs de saisie.",
          "",
          "Techniques :",
          "  â€¢ Commentaire : admin' -- (ignore le reste de la requÃªte)",
          "  â€¢ OR : ' OR '1'='1 (condition toujours vraie)",
          "  â€¢ UNION : rÃ©cupÃ©rer d'autres tables",
          "",
          "DÃ©fense : prepared statements, ORM, WAF.",
          "Outils rÃ©els : sqlmap, Burp Suite.",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("login ")) {
        const payload = input.slice(6);
        if (payload.includes("' --") || payload.includes("'--") || payload.toLowerCase().includes("' or '1'='1") || payload.toLowerCase().includes("' or 1=1") || payload.toLowerCase().includes("union select")) return null;
        return ["âœ— Identifiants incorrects. Essayez d'exploiter la requÃªte SQL."];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("login ")) return false;
      const p = input.slice(6).toLowerCase();
      return p.includes("' --") || p.includes("'--") || p.includes("' or '1'='1") || p.includes("' or 1=1") || p.includes("union select");
    },
    winResponse: [
      "âœ“ INJECTION SQL RÃ‰USSIE ! ConnectÃ© en tant qu'admin.",
      "",
      "âš  LEÃ‡ON :",
      "â†’ TOUJOURS utiliser des requÃªtes prÃ©parÃ©es (prepared statements).",
      "â†’ Ne jamais concatÃ©ner des entrÃ©es utilisateur dans du SQL.",
      "â†’ Valider et sanitizer cÃ´tÃ© serveur.",
    ],
  };
};

const generatePhishingLevel = (difficulty) => {
  const emailSets = {
    "dÃ©butant": [
      { from: "[email protected]", subject: "RÃ©union vendredi", body: "Bonjour,\nRÃ©union dÃ©placÃ©e Ã  vendredi 14h, salle B204.\nCordialement, Marie", legit: true },
      { from: "[email protected]", subject: "âš  URGENT : Compte suspendu !", body: "Cher client,\nActivitÃ© suspecte dÃ©tectÃ©e. Cliquez ICI :\nâ†’ http://banque-france.security-check.xyz/login\n\nSans action dans 24h, compte BLOQUÃ‰.", legit: false, indices: ["securite-banque.com â‰  site officiel", "URL: security-check.xyz â†’ frauduleux", "Urgence artificielle + menace"] },
      { from: "[email protected]", subject: "Mise Ã  jour sÃ©curitÃ©", body: "Bonjour,\nMise Ã  jour dispo sur https://support.microsoft.com\nPatch KB5034441.\nL'Ã©quipe IT", legit: true },
    ],
    "intermÃ©diaire": [
      { from: "[email protected]", subject: "Action requise : vÃ©rification sÃ©curitÃ©", body: "Bonjour,\nSuite Ã  notre audit trimestriel :\nâ†’ https://microsoft-365-security.com/verify\n\nCordialement,\nÃ‰quipe SÃ©curitÃ© Microsoft", legit: false, indices: ["microsoft-365-security.com â‰  microsoft.com", "Le 'o' dans micr0soft est un zÃ©ro", "Microsoft ne demande jamais de vÃ©rifier par email"] },
      { from: "[email protected]", subject: "Formation CybersÃ©curitÃ©", body: "Bonjour,\nInscription confirmÃ©e pour le 15 mars.\nLien Teams : https://teams.microsoft.com/meet/abc123\n\nRH", legit: true },
      { from: "[email protected]", subject: "Document partagÃ©", body: "Jean-Marc a partagÃ© 'Budget_Q4.xlsx'.\nâ†’ https://docs.google.com/spreadsheets/d/1a2b3c\n\nOuvrir dans Sheets", legit: true },
    ],
    "expert": [
      { from: "[email protected]", subject: "Re: AccÃ¨s VPN - Ticket #4892", body: "Bonjour,\nSuite Ã  votre ticket, nouveau client VPN :\nâ†’ https://vpn-corporate.entreprise-solutions.net/download\n\nMerci d'installer avant vendredi.\n\nSupport IT - Nicolas", legit: false, indices: ["entreprise-solutions.net â‰  domaine interne", "TÃ©lÃ©chargement de logiciel via email = suspect", "'Re:' sans conversation prÃ©cÃ©dente = social engineering"] },
      { from: "[email protected]", subject: "Certificat SSL expire", body: "Bonjour admin,\nCertificat SSL expire dans 7 jours.\nRenouvellement : https://portal.azure.com/certificates\n\nDevOps Team", legit: true },
      { from: "[email protected]", subject: "Facture #INV-2024-0892", body: "Bonjour,\nFacture janvier : 4 250,00 â‚¬\nâ†’ https://facturation.ovhcloud.com/invoices/892\n\nComptabilitÃ© OVH", legit: true },
    ],
  };

  const emails = emailSets[difficulty];
  const phishIndex = emails.findIndex((e) => !e.legit);

  return {
    id: "phishing",
    title: "DÃ‰TECTION PHISHING",
    mission: `${emails.length} emails interceptÃ©s. Identifiez le phishing ! Tapez 'read <n>' puis 'report <n>'.`,
    hint: `VÃ©rifiez domaines, URLs et ton. Le phishing est l'email #${phishIndex + 1}.`,
    topic: "Phishing & IngÃ©nierie sociale",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  read <1-3>      - Lire un email             â•‘",
          "â•‘  report <1-3>    - Signaler comme phishing   â•‘",
          "â•‘  analyze <1-3>   - Analyser les headers      â•‘",
          "â•‘  explain         - Comprendre le phishing    â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– DÃ‰TECTER LE PHISHING",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "ğŸ”´ Signaux d'alerte :",
          "  â€¢ Domaine d'expÃ©diteur suspect (typosquatting)",
          "  â€¢ URL ne correspondant pas au domaine officiel",
          "  â€¢ Urgence artificielle / menaces",
          "  â€¢ 'Re:' sans conversation prÃ©alable",
          "",
          "ğŸŸ¢ VÃ©rifications :",
          "  â€¢ Survoler les liens AVANT de cliquer",
          "  â€¢ VÃ©rifier le domaine exact",
          "  â€¢ En cas de doute, contacter par un autre canal",
        ],
      },
    },
    defaultResponse: (input) => {
      const match = input.match(/^(read|report|analyze) (\d)$/);
      if (!match) return null;
      const action = match[1];
      const idx = parseInt(match[2]) - 1;
      if (idx < 0 || idx >= emails.length) return [`âœ— Email #${idx + 1} n'existe pas.`];
      const email = emails[idx];

      if (action === "read") {
        return ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•", `ğŸ“§ EMAIL #${idx + 1}`, `De: ${email.from}`, `Objet: ${email.subject}`, "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€", ...email.body.split("\n"), "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"];
      }
      if (action === "analyze") {
        const domain = email.from.split("@")[1];
        return [`ğŸ” Headers email #${idx + 1} :`, `  From: ${email.from}`, `  Domain: ${domain}`, `  SPF: ${email.legit ? "PASS" : "SOFTFAIL"}`, `  DKIM: ${email.legit ? "PASS" : "NONE"}`, `  DMARC: ${email.legit ? "PASS" : "FAIL"}`, !email.legit ? "  âš  Authentification Ã©chouÃ©e !" : ""];
      }
      if (action === "report") {
        if (!email.legit) return null;
        return [`âœ— L'email #${idx + 1} est lÃ©gitime. Cherchez mieux !`];
      }
      return null;
    },
    checkWin: (input) => {
      const match = input.match(/^report (\d)$/);
      if (!match) return false;
      return parseInt(match[1]) - 1 === phishIndex;
    },
    winResponse: [
      `âœ“ CORRECT ! Phishing identifiÃ© !`,
      "",
      "ğŸ” Indices :",
      ...emails[phishIndex].indices.map((i) => `  â€¢ ${i}`),
      "",
      "âš  LEÃ‡ON :",
      "â†’ 91% des cyberattaques commencent par du phishing.",
      "â†’ Toujours vÃ©rifier domaine + URL.",
      "â†’ En entreprise, utiliser le bouton 'Report Phishing'.",
    ],
  };
};

const generateHashLevel = () => {
  const hashes = [
    { plain: "password", md5: "5f4dcc3b5aa765d61d8327deb882cf99" },
    { plain: "admin", md5: "21232f297a57a5a743894a0e4a801fc3" },
    { plain: "letmein", md5: "0d107d09f5bbe40cade3de5c71e9e9b7" },
  ];
  const chosen = pick(hashes);

  return {
    id: "hash",
    title: "RAINBOW TABLES",
    mission: `Hash MD5 interceptÃ© : '${chosen.md5}'. Retrouvez le mot de passe original avec 'rainbow <hash>' ou 'crack <hash>'.`,
    hint: "Les rainbow tables contiennent des millions de hash prÃ©-calculÃ©s. Tapez: rainbow " + chosen.md5,
    topic: "Hachage & Rainbow Tables",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  rainbow <hash>  - Chercher dans rainbow tableâ•‘",
          "â•‘  crack <hash>    - Attaque dictionnaire       â•‘",
          "â•‘  hash <texte>    - Calculer le hash d'un texteâ•‘",
          "â•‘  explain         - Comprendre le hachage      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– HACHAGE",
          "â”â”â”â”â”â”â”â”â”â”",
          "Fonction Ã  sens unique : texte â†’ empreinte fixe.",
          "  MD5    : 128 bits (CASSÃ‰)",
          "  SHA-1  : 160 bits (CASSÃ‰)",
          "  SHA-256: 256 bits (sÃ»r)",
          "  bcrypt : hachage + sel + coÃ»t variable (RECOMMANDÃ‰)",
          "",
          "Rainbow table = base de hash prÃ©-calculÃ©s.",
          "DÃ©fense : sel (salt) unique par password.",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("rainbow ") || input.startsWith("crack ")) {
        const h = input.split(" ").slice(1).join(" ").trim();
        if (h === chosen.md5) return null;
        return ["âœ— Hash non trouvÃ© dans la rainbow table."];
      }
      if (input.startsWith("hash ")) {
        const text = input.slice(5).trim();
        const fakeHash = Array.from({ length: 32 }, () => "0123456789abcdef"[randInt(0, 15)]).join("");
        if (text === chosen.plain) return [`â†’ MD5(${text}) = ${chosen.md5}`, "C'est le mÃªme hash !"];
        return [`â†’ MD5(${text}) = ${fakeHash}`];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("rainbow ") && !input.startsWith("crack ")) return false;
      return input.split(" ").slice(1).join(" ").trim() === chosen.md5;
    },
    winResponse: [
      `âŸ³ Recherche rainbow table...`,
      `  ${chosen.md5} â†’ "${chosen.plain}"`,
      "",
      `âœ“ PASSWORD TROUVÃ‰ : ${chosen.plain}`,
      "",
      "âš  LEÃ‡ON :",
      "â†’ MD5 et SHA-1 sont CASSÃ‰S pour le stockage de passwords.",
      "â†’ DÃ©fense : bcrypt/Argon2 avec un sel unique par utilisateur.",
    ],
  };
};

const generateOSINTLevel = () => {
  const targets = [
    { name: "Alex Morin", username: "alexm_dev", bio: "Full-stack dev ğŸš€ | Paris | Cat lover ğŸ± | Born 15/03/1995", posts: ["Just deployed on AWS us-east-1 ! ğŸ‰", "Birthday dinner at Le Petit Cler ğŸ‚", "My cat Pixel turned 3 today !", "Working from CafÃ© de Flore â˜•"], password: "Pixel1503", hint: "PrÃ©nom du chat + date naissance JJMM." },
    { name: "Sarah Benali", username: "sarah.benali", bio: "Marketing @TechCorp | Lyon | ğŸƒâ€â™€ï¸ Marathon Paris 2024 | Dog mom to Oscar", posts: ["Oscar fÃªte ses 5 ans ! ğŸ•", "Paris Marathon in 4h12 ! Personal best !", "Throwback wedding 07/07/2019 ğŸ’•", "Working late at Lyon office..."], password: "Oscar0707", hint: "Nom du chien + date importante JJMM." },
  ];
  const target = pick(targets);

  return {
    id: "osint",
    title: "OSINT - RENSEIGNEMENT",
    mission: `Cible : ${target.name} (@${target.username}). Trouvez son mot de passe via ses rÃ©seaux sociaux. Commande: 'try <password>'.`,
    hint: target.hint,
    topic: "OSINT & IngÃ©nierie Sociale",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  profile          - Voir le profil social     â•‘",
          "â•‘  posts            - Voir les publications     â•‘",
          "â•‘  try <password>   - Tester un mot de passe    â•‘",
          "â•‘  explain          - Comprendre l'OSINT        â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      profile: {
        response: [`ğŸ‘¤ @${target.username}`, `   ${target.name}`, `   Bio: ${target.bio}`, `   Followers: ${randInt(200, 2000)}`, "", "â†’ Tapez 'posts' pour les publications."],
      },
      posts: {
        response: [`ğŸ“± @${target.username} :`, "", ...target.posts.map((p, i) => `  ${["ğŸ• 2h", "ğŸ•‘ 1j", "ğŸ•’ 3j", "ğŸ•“ 1sem"][i]} â”‚ ${p}`), "", "â†’ Cherchez des indices personnels."],
      },
      explain: {
        response: [
          "ğŸ“– OSINT (Open Source Intelligence)",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "Collecte d'infos Ã  partir de sources publiques.",
          "  â€¢ Noms d'animaux â†’ passwords courants",
          "  â€¢ Dates perso â†’ codes PIN",
          "  â€¢ Lieux â†’ questions de sÃ©curitÃ©",
          "",
          "Outils : Maltego, theHarvester, Sherlock, Google Dorks.",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("try ")) {
        const guess = input.slice(4).trim();
        if (guess === target.password) return null;
        return ["âœ— Mot de passe incorrect. Analysez mieux le profil."];
      }
      return null;
    },
    checkWin: (input) => input.startsWith("try ") && input.slice(4).trim() === target.password,
    winResponse: [
      `âœ“ ACCÃˆS ! Password : "${target.password}"`,
      "",
      "âš  LEÃ‡ON :",
      "â†’ Ne JAMAIS utiliser d'infos personnelles dans un password.",
      "â†’ Limiter les infos partagÃ©es sur les rÃ©seaux sociaux.",
      "â†’ Utiliser un gÃ©nÃ©rateur de mots de passe alÃ©atoires.",
    ],
  };
};

const generateNetworkLevel = () => {
  const suspicious = "192.168.1.105";
  const malicious = "185.143.223.1";
  const logs = [
    "10:01:03 | 192.168.1.100 â†’ 192.168.1.1   | TCP | Port 80   | HTTP GET /index",
    "10:01:05 | 192.168.1.100 â†’ 8.8.8.8        | UDP | Port 53   | DNS google.com",
    "10:01:07 | 192.168.1.105 â†’ 45.33.32.156   | TCP | Port 443  | TLS Hello",
    `10:01:09 | ${suspicious} â†’ ${malicious}  | TCP | Port 4444 | DATA â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ`,
    "10:01:11 | 192.168.1.100 â†’ 192.168.1.1    | TCP | Port 443  | HTTPS /api",
    `10:01:13 | ${malicious} â†’ ${suspicious}  | TCP | Port 4444 | DATA â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ`,
    "10:01:15 | 192.168.1.100 â†’ 192.168.1.50   | TCP | Port 22   | SSH",
  ];

  return {
    id: "network",
    title: "ANALYSE RÃ‰SEAU",
    mission: "Analysez les logs rÃ©seau. Identifiez la machine compromise avec 'flag <ip>'. Tapez 'logs' pour voir le trafic.",
    hint: `Port 4444 = Metasploit reverse shell. Tapez: flag ${suspicious}`,
    topic: "Analyse de trafic rÃ©seau",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  logs             - Voir les logs rÃ©seau      â•‘",
          "â•‘  whois <ip>       - Info sur une IP           â•‘",
          "â•‘  flag <ip>        - Identifier la machine     â•‘",
          "â•‘  explain          - Comprendre l'analyse      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      logs: {
        response: [
          "ğŸ“‹ CAPTURE RÃ‰SEAU :",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          ...logs,
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "",
          "â†’ Identifiez l'activitÃ© suspecte.",
        ],
      },
      explain: {
        response: [
          "ğŸ“– ANALYSE RÃ‰SEAU",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "Ports courants : 22=SSH, 53=DNS, 80=HTTP, 443=HTTPS",
          "Ports suspects : 4444=Metasploit, 5555=ADB, 1337=leet",
          "",
          "Signaux d'alerte :",
          "  â€¢ Ports non-standard vers IP externes",
          "  â€¢ DonnÃ©es chiffrÃ©es sur ports inhabituels",
          "  â€¢ Communication bidirectionnelle suspecte",
          "",
          "Outils : Wireshark, tcpdump, Zeek, Suricata.",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("whois ")) {
        const ip = input.slice(6).trim();
        if (ip === malicious) return [`ğŸ” WHOIS ${ip} :`, `  Pays: Russie`, `  Org: Bulletproof Hosting Ltd`, `  âš  IP sur listes de menaces !`];
        if (ip === suspicious) return [`ğŸ” WHOIS ${ip} :`, `  RÃ©seau local`, `  Host: DESKTOP-PC105`, `  User: j.martin`];
        return [`ğŸ” WHOIS ${ip} :`, `  RÃ©seau local (privÃ©)`];
      }
      if (input.startsWith("flag ")) {
        const ip = input.slice(5).trim();
        if (ip === suspicious) return null;
        return [`âœ— ${ip} ne semble pas compromise. Analysez les ports.`];
      }
      return null;
    },
    checkWin: (input) => input.startsWith("flag ") && input.slice(5).trim() === suspicious,
    winResponse: [
      `âœ“ MACHINE COMPROMISE : ${suspicious}`,
      `  Reverse shell Metasploit (port 4444) vers ${malicious}`,
      "",
      "âš  LEÃ‡ON :",
      "â†’ Surveiller les connexions sortantes sur ports non-standard.",
      "â†’ Les reverse shells utilisent souvent 4444, 1234, 8888.",
      "â†’ Outils : Wireshark, Suricata, Splunk SIEM.",
    ],
  };
};

// â”€â”€â”€ PROFILES â”€â”€â”€
const PROFILES = {
  "dÃ©butant": {
    label: "ğŸŸ¢ DÃ‰BUTANT",
    desc: "LycÃ©en / Curieux â€” DÃ©couverte des bases",
    color: "#0f0",
    levels: () => [generateScanLevel(), generateBruteForceLevel("dÃ©butant"), generateCaesarLevel("dÃ©butant"), generateBase64Level("dÃ©butant"), generatePhishingLevel("dÃ©butant")],
  },
  "intermÃ©diaire": {
    label: "ğŸŸ¡ INTERMÃ‰DIAIRE",
    desc: "Ã‰tudiant IT / Bac+2 â€” Pentest basique",
    color: "#ff0",
    levels: () => [generateScanLevel(), generateBruteForceLevel("intermÃ©diaire"), generateCaesarLevel("intermÃ©diaire"), generateBase64Level("intermÃ©diaire"), generateSQLiLevel("intermÃ©diaire"), generateOSINTLevel(), generatePhishingLevel("intermÃ©diaire")],
  },
  "expert": {
    label: "ğŸ”´ EXPERT",
    desc: "M1/M2 Cyber â€” Challenges avancÃ©s",
    color: "#f44",
    levels: () => [generateScanLevel(), generateBruteForceLevel("expert"), generateCaesarLevel("expert"), generateBase64Level("expert"), generateHashLevel(), generateSQLiLevel("expert"), generateOSINTLevel(), generateNetworkLevel(), generatePhishingLevel("expert")],
  },
};

// â”€â”€â”€ MATRIX RAIN â”€â”€â”€
const MatrixRain = () => {
  const canvasRef = useRef(null);
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const resize = () => { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; };
    resize();
    const chars = "01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½";
    const fontSize = 14;
    const columns = Math.floor(canvas.width / fontSize);
    const drops = Array(columns).fill(1);
    const draw = () => {
      ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0f0";
      ctx.font = `${fontSize}px monospace`;
      for (let i = 0; i < drops.length; i++) {
        ctx.globalAlpha = Math.random() * 0.3 + 0.1;
        ctx.fillText(chars[Math.floor(Math.random() * chars.length)], i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
      }
      ctx.globalAlpha = 1;
    };
    const interval = setInterval(draw, 50);
    window.addEventListener("resize", resize);
    return () => { clearInterval(interval); window.removeEventListener("resize", resize); };
  }, []);
  return <canvas ref={canvasRef} style={{ position: "absolute", top: 0, left: 0, width: "100%", height: "100%", opacity: 0.12, pointerEvents: "none" }} />;
};

// â”€â”€â”€ MAIN GAME â”€â”€â”€
export default function HackerGame() {
  const [screen, setScreen] = useState("menu");
  const [profile, setProfile] = useState(null);
  const [levels, setLevels] = useState([]);
  const [levelIdx, setLevelIdx] = useState(0);
  const [lines, setLines] = useState([]);
  const [input, setInput] = useState("");
  const [hintsUsed, setHintsUsed] = useState(0);
  const [startTime, setStartTime] = useState(null);
  const [playerName, setPlayerName] = useState("");
  const [leaderboard, setLeaderboard] = useState([]);
  const termRef = useRef(null);
  const inputRef = useRef(null);

  const scrollToBottom = useCallback(() => {
    if (termRef.current) setTimeout(() => { termRef.current.scrollTop = termRef.current.scrollHeight; }, 50);
  }, []);

  useEffect(() => { scrollToBottom(); }, [lines, scrollToBottom]);

  const startGame = (profileKey) => {
    const p = PROFILES[profileKey];
    const gen = p.levels();
    setProfile(profileKey);
    setLevels(gen);
    setLevelIdx(0);
    setHintsUsed(0);
    setStartTime(Date.now());
    setLines([
      { type: "system", text: `â•â•â•â•â•â• NIVEAU 1/${gen.length} : ${gen[0].title} â•â•â•â•â•â•` },
      { type: "system", text: `ğŸ“¡ ${gen[0].topic}` },
      { type: "mission", text: gen[0].mission },
      { type: "empty", text: "" },
    ]);
    setScreen("game");
  };

  const addLines = (newLines, type = "response") => setLines((prev) => [...prev, ...newLines.map((text) => ({ type, text }))]);

  const advanceLevel = () => {
    if (levelIdx < levels.length - 1) {
      const next = levelIdx + 1;
      setLevelIdx(next);
      setTimeout(() => {
        addLines(["", `â•â•â•â•â•â• NIVEAU ${next + 1}/${levels.length} : ${levels[next].title} â•â•â•â•â•â•`, `ğŸ“¡ ${levels[next].topic}`], "system");
        addLines([levels[next].mission], "mission");
        addLines([""], "empty");
      }, 800);
    } else {
      setTimeout(() => setScreen("victory"), 1000);
    }
  };

  const handleCommand = (cmd) => {
    const original = cmd.trim();
    const trimmed = original.toLowerCase();
    if (!trimmed) return;
    setLines((prev) => [...prev, { type: "input", text: `â¯â¯ ${original}` }]);

    if (trimmed === "clear") { setLines([]); return; }
    if (trimmed === "mission") { addLines([levels[levelIdx].mission], "mission"); return; }
    if (trimmed === "hint") { setHintsUsed((h) => h + 1); addLines(["ğŸ’¡ " + levels[levelIdx].hint], "hint"); return; }
    if (trimmed === "score") {
      const e = Math.floor((Date.now() - startTime) / 1000);
      addLines([`Niveau: ${levelIdx + 1}/${levels.length} | Hints: ${hintsUsed} | Temps: ${Math.floor(e / 60)}m${String(e % 60).padStart(2, "0")}s`], "system");
      return;
    }

    const cl = levels[levelIdx];
    const proc = (trimmed.startsWith("decode ") || trimmed.startsWith("caesar ") || trimmed.startsWith("login ") || trimmed.startsWith("try "))
      ? original.replace(/^\S+/, (m) => m.toLowerCase()) : trimmed;

    if (cl.checkWin && cl.checkWin(proc)) { if (cl.winResponse) addLines(cl.winResponse, "success"); advanceLevel(); return; }
    if (cl.commands[trimmed]) { const r = cl.commands[trimmed]; addLines(r.response, r.nextLevel ? "success" : "response"); if (r.nextLevel) advanceLevel(); return; }
    if (cl.defaultResponse) { const r = cl.defaultResponse(proc); if (r) { addLines(r, "response"); return; } }
    addLines(["Commande non reconnue. Tapez 'help'."], "error");
  };

  const handleKeyDown = (e) => { if (e.key === "Enter") { handleCommand(input); setInput(""); } };
  const focusInput = () => inputRef.current?.focus();
  const getScore = () => {
    const e = Math.floor((Date.now() - startTime) / 1000);
    const base = { "dÃ©butant": 500, "intermÃ©diaire": 750, "expert": 1000 }[profile] || 500;
    return Math.max(0, base - hintsUsed * 50 - Math.floor(e / 15));
  };

  // â”€â”€â”€ MENU â”€â”€â”€
  if (screen === "menu") {
    return (
      <div style={{ minHeight: "100vh", background: "#0a0a0a", fontFamily: "'Fira Code','Cascadia Code',monospace", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", position: "relative", overflow: "hidden" }}>
        <MatrixRain />
        <div style={{ zIndex: 10, textAlign: "center", maxWidth: "700px", padding: "20px" }}>
          <div style={{ color: "#0a0", fontSize: "11px", letterSpacing: "8px", marginBottom: "16px", opacity: 0.5 }}>Ã‰COLE IT VALENCIENNES</div>
          <h1 style={{ color: "#0f0", fontSize: "38px", margin: "0 0 6px", textShadow: "0 0 30px rgba(0,255,0,0.4)", letterSpacing: "4px" }}>CYBER TERMINAL</h1>
          <div style={{ color: "#0a0", fontSize: "13px", letterSpacing: "5px", marginBottom: "40px", opacity: 0.7 }}>HACKING Ã‰THIQUE â€” V2</div>
          <div style={{ marginBottom: "30px" }}>
            <input value={playerName} onChange={(e) => setPlayerName(e.target.value)} placeholder="Votre pseudo (optionnel)" maxLength={20}
              style={{ background: "rgba(0,255,0,0.05)", border: "1px solid #1a3a1a", color: "#0f0", padding: "10px 16px", fontSize: "14px", fontFamily: "inherit", textAlign: "center", borderRadius: "4px", outline: "none", width: "250px" }}
              onFocus={(e) => e.target.style.borderColor = "#0f0"} onBlur={(e) => e.target.style.borderColor = "#1a3a1a"} />
          </div>
          <div style={{ color: "#888", fontSize: "13px", marginBottom: "24px", letterSpacing: "2px" }}>CHOISISSEZ VOTRE NIVEAU</div>
          <div style={{ display: "flex", gap: "16px", justifyContent: "center", flexWrap: "wrap" }}>
            {Object.entries(PROFILES).map(([key, p]) => (
              <button key={key} onClick={() => startGame(key)}
                style={{ background: "rgba(0,0,0,0.8)", border: `1px solid ${p.color}33`, color: p.color, padding: "20px 24px", fontFamily: "inherit", fontSize: "13px", cursor: "pointer", borderRadius: "4px", width: "200px", textAlign: "left", transition: "all 0.3s", boxShadow: `0 0 20px ${p.color}11` }}
                onMouseOver={(e) => { e.currentTarget.style.borderColor = p.color; e.currentTarget.style.boxShadow = `0 0 30px ${p.color}33`; }}
                onMouseOut={(e) => { e.currentTarget.style.borderColor = `${p.color}33`; e.currentTarget.style.boxShadow = `0 0 20px ${p.color}11`; }}>
                <div style={{ fontSize: "16px", marginBottom: "8px", fontWeight: "bold" }}>{p.label}</div>
                <div style={{ color: "#888", fontSize: "11px", lineHeight: "1.5" }}>{p.desc}</div>
                <div style={{ color: "#555", fontSize: "10px", marginTop: "8px" }}>{p.levels().length} niveaux â€¢ RandomisÃ©</div>
              </button>
            ))}
          </div>
          {leaderboard.length > 0 && (
            <div style={{ marginTop: "40px", maxWidth: "400px", margin: "40px auto 0" }}>
              <div style={{ color: "#ff0", fontSize: "12px", letterSpacing: "2px", marginBottom: "12px", textAlign: "left" }}>ğŸ† LEADERBOARD</div>
              {leaderboard.slice(0, 8).map((e, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", color: i === 0 ? "#ff0" : "#666", fontSize: "12px", padding: "4px 0", borderBottom: "1px solid #111" }}>
                  <span>{i + 1}. {e.name}</span><span>{e.score} pts â€” {e.profile}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  // â”€â”€â”€ VICTORY â”€â”€â”€
  if (screen === "victory") {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const score = getScore();
    const p = PROFILES[profile];
    return (
      <div style={{ minHeight: "100vh", background: "#0a0a0a", fontFamily: "'Fira Code',monospace", display: "flex", alignItems: "center", justifyContent: "center", position: "relative", overflow: "hidden" }}>
        <MatrixRain />
        <div style={{ zIndex: 10, textAlign: "center", padding: "50px", border: `1px solid ${p.color}44`, borderRadius: "8px", background: "rgba(0,0,0,0.9)", boxShadow: `0 0 60px ${p.color}15` }}>
          <div style={{ fontSize: "48px", marginBottom: "16px" }}>ğŸ†</div>
          <h1 style={{ color: p.color, fontSize: "26px", margin: "0 0 6px", letterSpacing: "4px" }}>MISSION ACCOMPLIE</h1>
          <div style={{ color: "#555", fontSize: "12px", letterSpacing: "3px", marginBottom: "30px" }}>{p.label}</div>
          <div style={{ color: "#888", marginBottom: "30px", lineHeight: "2.2", fontSize: "14px" }}>
            <div>Niveaux : <span style={{ color: p.color }}>{levels.length}/{levels.length}</span></div>
            <div>Temps : <span style={{ color: p.color }}>{Math.floor(elapsed / 60)}m {String(elapsed % 60).padStart(2, "0")}s</span></div>
            <div>Indices : <span style={{ color: hintsUsed === 0 ? "#0f0" : "#ff0" }}>{hintsUsed}</span></div>
            <div style={{ fontSize: "22px", marginTop: "8px" }}>Score : <span style={{ color: p.color }}>{score}</span></div>
          </div>
          <div style={{ color: "#444", fontSize: "11px", marginBottom: "24px", maxWidth: "380px", lineHeight: "1.6" }}>
            {levels.map((l) => l.topic).join(" Â· ")}
          </div>
          <div style={{ display: "flex", gap: "12px", justifyContent: "center", flexWrap: "wrap" }}>
            <button onClick={() => {
              setLeaderboard((prev) => [...prev, { name: playerName || "Anonyme", score, profile: p.label, time: elapsed }].sort((a, b) => b.score - a.score));
              setScreen("menu");
            }} style={{ background: p.color, color: "#000", border: "none", padding: "12px 28px", fontFamily: "inherit", fontSize: "13px", fontWeight: "bold", cursor: "pointer", letterSpacing: "2px", borderRadius: "2px" }}>
              SAUVER & MENU
            </button>
            <button onClick={() => startGame(profile)}
              style={{ background: "transparent", color: p.color, border: `1px solid ${p.color}`, padding: "12px 28px", fontFamily: "inherit", fontSize: "13px", cursor: "pointer", letterSpacing: "2px", borderRadius: "2px" }}>
              REJOUER
            </button>
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€â”€ GAME â”€â”€â”€
  const p = PROFILES[profile];
  return (
    <div style={{ minHeight: "100vh", background: "#0a0a0a", fontFamily: "'Fira Code',monospace", display: "flex", flexDirection: "column", position: "relative" }} onClick={focusInput}>
      <div style={{ background: "#111", borderBottom: "1px solid #1a1a1a", padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "8px", zIndex: 10 }}>
        <div style={{ display: "flex", alignItems: "center", gap: "12px", flexWrap: "wrap" }}>
          <span style={{ color: p.color, fontSize: "13px", fontWeight: "bold" }}>â¬¡ CYBER TERMINAL</span>
          <span style={{ color: "#333" }}>|</span>
          <span style={{ color: p.color, fontSize: "11px" }}>{p.label}</span>
          <span style={{ color: "#333" }}>|</span>
          <span style={{ color: "#0a0", fontSize: "11px" }}>{levels[levelIdx]?.title}</span>
        </div>
        <div style={{ display: "flex", gap: "10px", alignItems: "center" }}>
          {playerName && <span style={{ color: "#555", fontSize: "11px" }}>{playerName}</span>}
          <span style={{ color: "#555", fontSize: "11px" }}>LVL {levelIdx + 1}/{levels.length}</span>
          <div style={{ display: "flex", gap: "3px" }}>
            {levels.map((_, i) => (
              <div key={i} style={{ width: "7px", height: "7px", borderRadius: "50%", background: i < levelIdx ? "#0f0" : i === levelIdx ? p.color : "#222", boxShadow: i < levelIdx ? "0 0 4px #0f0" : i === levelIdx ? `0 0 6px ${p.color}` : "none", transition: "all 0.3s" }} />
            ))}
          </div>
          <button onClick={() => setScreen("menu")} style={{ background: "none", border: "1px solid #333", color: "#555", padding: "2px 8px", fontFamily: "inherit", fontSize: "10px", cursor: "pointer", borderRadius: "2px" }}>MENU</button>
        </div>
      </div>
      <div ref={termRef} style={{ flex: 1, overflowY: "auto", padding: "14px 16px", paddingBottom: "65px" }}>
        {lines.map((line, i) => {
          if (line.type === "empty") return <div key={i} style={{ height: "10px" }} />;
          const colors = { system: "#0a0", input: "#fff", success: "#0f0", error: "#f44", hint: "#ff0", mission: "#6af", response: "#aaa" };
          return <div key={i} style={{ color: colors[line.type] || "#aaa", fontSize: "13px", lineHeight: "1.6", whiteSpace: "pre-wrap", fontFamily: "inherit" }}>{line.text}</div>;
        })}
      </div>
      <div style={{ position: "fixed", bottom: 0, left: 0, right: 0, background: "#111", borderTop: "1px solid #1a1a1a", padding: "10px 16px", display: "flex", alignItems: "center", gap: "8px", zIndex: 10 }}>
        <span style={{ color: p.color, fontSize: "14px" }}>â¯â¯</span>
        <input ref={inputRef} value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKeyDown} autoFocus placeholder="Tapez une commande..."
          style={{ flex: 1, background: "transparent", border: "none", outline: "none", color: "#fff", fontSize: "14px", fontFamily: "inherit", caretColor: p.color }} />
        <span style={{ color: "#333", fontSize: "10px" }}>ENTER â†µ</span>
      </div>
    </div>
  );
}


/* ------------------- */
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HackerGame />);
    </script>
</body>
</html>
