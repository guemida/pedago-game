<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ RÃ©seau & Infra â€” Challenge Terminal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { height: 100%; width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" src="network-game.jsx"></script>
    <script type="text/babel">

        /* --------------------------- */

import { useState, useEffect, useRef, useCallback } from "react";

// â”€â”€â”€ Utility: shuffle array â”€â”€â”€
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// â”€â”€â”€ Level definitions â”€â”€â”€
function generateLevels() {
  // Random subnet for level 2
  const subnetSets = [
    { mask: "255.255.255.0", cidr: "/24", hosts: "254", network: "192.168.1.0", broadcast: "192.168.1.255" },
    { mask: "255.255.255.128", cidr: "/25", hosts: "126", network: "10.0.0.0", broadcast: "10.0.0.127" },
    { mask: "255.255.0.0", cidr: "/16", hosts: "65534", network: "172.16.0.0", broadcast: "172.16.255.255" },
  ];
  const subnet = subnetSets[Math.floor(Math.random() * subnetSets.length)];

  // Random DNS for level 3
  const dnsSets = [
    { domain: "api.ecole-ingenieurs.fr", ip: "51.158.97.42", type: "A" },
    { domain: "mail.campus-tech.io", ip: "185.12.64.10", type: "A" },
    { domain: "intranet.univ-paris.fr", ip: "193.51.24.81", type: "A" },
  ];
  const dns = dnsSets[Math.floor(Math.random() * dnsSets.length)];

  // Random firewall port for level 5
  const fwSets = [
    { port: "3306", service: "MySQL", rule: "DENY" },
    { port: "5432", service: "PostgreSQL", rule: "DENY" },
    { port: "27017", service: "MongoDB", rule: "DENY" },
  ];
  const fw = fwSets[Math.floor(Math.random() * fwSets.length)];

  // Random VLAN for level 6
  const vlanSets = [
    { id: "10", name: "ADMIN", subnet: "192.168.10.0/24" },
    { id: "20", name: "DEV", subnet: "192.168.20.0/24" },
    { id: "30", name: "GUEST", subnet: "192.168.30.0/24" },
  ];
  const vlan = vlanSets[Math.floor(Math.random() * vlanSets.length)];

  return [
    // â”€â”€â”€ LEVEL 0: INTRO â”€â”€â”€
    {
      id: 0,
      title: "INITIALISATION RÃ‰SEAU",
      topic: "Introduction",
      mission: "Bienvenue, technicien rÃ©seau. Tapez 'help' pour commencer.",
      hint: "Commencez par taper: help",
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘          COMMANDES DISPONIBLES                â•‘",
            "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
            "â•‘  help       - Afficher cette aide             â•‘",
            "â•‘  ifconfig   - Voir la config rÃ©seau           â•‘",
            "â•‘  scan       - Scanner le rÃ©seau local         â•‘",
            "â•‘  mission    - Voir la mission en cours        â•‘",
            "â•‘  hint       - Obtenir un indice               â•‘",
            "â•‘  explain    - Cours sur le sujet du niveau    â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        ifconfig: {
          response: [
            "eth0:",
            "  inet 192.168.1.100/24",
            "  ether 0a:1b:2c:3d:4e:5f",
            "  gateway 192.168.1.1",
            "  status: UP",
            "",
            "lo:",
            "  inet 127.0.0.1/8",
            "  status: UP",
          ],
        },
        scan: {
          response: [
            "âŸ³ Scanning 192.168.1.0/24...",
            "",
            "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "  â”‚ IP               â”‚ TYPE     â”‚ PORTS OUVERTS   â”‚",
            "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "  â”‚ 192.168.1.1      â”‚ ROUTER   â”‚ 80, 443         â”‚",
            "  â”‚ 192.168.1.10     â”‚ SERVEUR  â”‚ 22, 80, 443     â”‚",
            "  â”‚ 192.168.1.20     â”‚ SWITCH   â”‚ 23, 161         â”‚",
            "  â”‚ 192.168.1.50     â”‚ IMPRIM.  â”‚ 631, 9100       â”‚",
            "  â”‚ 192.168.1.100    â”‚ VOUS     â”‚ â€”               â”‚",
            "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
            "",
            "â†’ RÃ©seau scannÃ© ! Tapez 'connect router' pour configurer le rÃ©seau.",
          ],
        },
        explain: {
          response: [
            "ğŸ“– LE RÃ‰SEAU LOCAL (LAN)",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "Un LAN connecte des machines proches (bureau, Ã©cole).",
            "Chaque appareil a :",
            "  â€¢ Une adresse IP (ex: 192.168.1.100)",
            "  â€¢ Une adresse MAC (identifiant physique unique)",
            "  â€¢ Un masque de sous-rÃ©seau (dÃ©limite le rÃ©seau)",
            "  â€¢ Une passerelle (gateway) pour sortir du LAN",
            "",
            "Outils de base : ifconfig, ping, scan, traceroute",
          ],
        },
        "connect router": {
          response: [
            "âœ“ Connexion au routeur 192.168.1.1 Ã©tablie.",
            "  Firmware: OpenWRT 23.05",
            "  Uptime: 47 jours",
            "",
            "â†’ AccÃ¨s rÃ©seau confirmÃ©. Niveau suivant dÃ©bloquÃ© !",
          ],
          nextLevel: true,
        },
      },
    },

    // â”€â”€â”€ LEVEL 1: PING & CONNECTIVITÃ‰ â”€â”€â”€
    {
      id: 1,
      title: "DIAGNOSTIC RÃ‰SEAU",
      topic: "Ping & ConnectivitÃ©",
      mission: "Un serveur ne rÃ©pond plus. Utilisez 'ping' pour diagnostiquer, puis 'traceroute' pour localiser le problÃ¨me.",
      hint: "Essayez: ping 192.168.1.10, puis ping 8.8.8.8, puis traceroute 8.8.8.8",
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  ping <ip>       - Tester la connectivitÃ©     â•‘",
            "â•‘  traceroute <ip> - Tracer le chemin rÃ©seau     â•‘",
            "â•‘  diagnose        - Analyser le problÃ¨me       â•‘",
            "â•‘  explain         - Comprendre ping/traceroute â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        explain: {
          response: [
            "ğŸ“– PING & TRACEROUTE",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "PING envoie un paquet ICMP Echo Request :",
            "  â†’ Si rÃ©ponse : la machine est joignable",
            "  â†’ Si timeout : problÃ¨me rÃ©seau ou machine down",
            "",
            "TRACEROUTE affiche chaque routeur traversÃ© :",
            "  â†’ Permet de localiser OÃ™ le paquet se perd",
            "  â†’ Chaque 'hop' = un routeur intermÃ©diaire",
            "",
            "TTL (Time To Live) : compteur qui s'incrÃ©mente",
            "Ã  chaque hop pour dÃ©couvrir la route.",
          ],
        },
        "ping 192.168.1.10": {
          response: [
            "PING 192.168.1.10 :",
            "  64 bytes from 192.168.1.10: ttl=64 time=0.8ms",
            "  64 bytes from 192.168.1.10: ttl=64 time=0.6ms",
            "  64 bytes from 192.168.1.10: ttl=64 time=0.9ms",
            "  âœ“ Serveur local OK â€” 0% packet loss",
          ],
        },
        "ping 192.168.1.1": {
          response: [
            "PING 192.168.1.1 :",
            "  64 bytes from 192.168.1.1: ttl=64 time=1.2ms",
            "  âœ“ Gateway OK",
          ],
        },
        "ping 8.8.8.8": {
          response: [
            "PING 8.8.8.8 :",
            "  Request timeout for icmp_seq 0",
            "  Request timeout for icmp_seq 1",
            "  Request timeout for icmp_seq 2",
            "  âœ— 100% packet loss â€” Pas d'accÃ¨s Internet !",
            "",
            "â†’ Le LAN fonctionne mais pas Internet. Lancez traceroute 8.8.8.8",
          ],
        },
        "traceroute 8.8.8.8": {
          response: [
            "traceroute to 8.8.8.8 :",
            "  1  192.168.1.1    1.2ms   âœ“ (votre gateway)",
            "  2  10.0.0.1       3.5ms   âœ“ (routeur FAI)",
            "  3  82.64.12.1     8.1ms   âœ“ (backbone FAI)",
            "  4  * * *          âœ— TIMEOUT",
            "  5  * * *          âœ— TIMEOUT",
            "",
            "âš  Le paquet se perd au hop 4 â€” problÃ¨me chez le FAI !",
            "â†’ Tapez 'diagnose' pour conclure.",
          ],
        },
        diagnose: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  DIAGNOSTIC RÃ‰SEAU                            â•‘",
            "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
            "â•‘  âœ“ LAN         : Fonctionnel                 â•‘",
            "â•‘  âœ“ Gateway     : Joignable                   â•‘",
            "â•‘  âœ“ FAI hop 1-3 : OK                          â•‘",
            "â•‘  âœ— FAI hop 4+  : PERTE DE PAQUETS            â•‘",
            "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
            "â•‘  Conclusion: Panne chez le FAI, pas locale.  â•‘",
            "â•‘  Action: Contacter le support FAI.            â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
            "",
            "âœ“ Diagnostic correct ! Niveau suivant dÃ©bloquÃ©.",
          ],
          nextLevel: true,
        },
      },
    },

    // â”€â”€â”€ LEVEL 2: SUBNETTING â”€â”€â”€
    {
      id: 2,
      title: "CALCUL DE SOUS-RÃ‰SEAU",
      topic: "Subnetting",
      mission: `RÃ©seau: ${subnet.network}${subnet.cidr}. Calculez le nombre d'hÃ´tes possibles. Tapez 'answer <nombre>'.`,
      hint: `Masque ${subnet.mask} = ${subnet.cidr}. Formule : 2^(32-prefix) - 2. La rÃ©ponse est ${subnet.hosts}.`,
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  subnet info     - Voir les infos rÃ©seau      â•‘",
            "â•‘  answer <nombre> - Donner votre rÃ©ponse       â•‘",
            "â•‘  explain         - Comprendre le subnetting   â•‘",
            "â•‘  calc <cidr>     - Aide au calcul             â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        explain: {
          response: [
            "ğŸ“– SUBNETTING (SOUS-RÃ‰SEAU)",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "Une adresse IPv4 = 32 bits : RÃ‰SEAU | HÃ”TE",
            "",
            "Le masque dÃ©finit la frontiÃ¨re :",
            "  /24 = 255.255.255.0   â†’ 8 bits hÃ´te  â†’ 2â¸-2 = 254 hÃ´tes",
            "  /25 = 255.255.255.128 â†’ 7 bits hÃ´te  â†’ 2â·-2 = 126 hÃ´tes",
            "  /16 = 255.255.0.0     â†’ 16 bits hÃ´te â†’ 2Â¹â¶-2 = 65534 hÃ´tes",
            "",
            "On retire 2 : adresse rÃ©seau + broadcast",
            "",
            "Notation CIDR: /24 = les 24 premiers bits sont le rÃ©seau",
            "Bits hÃ´te = 32 - prÃ©fixe CIDR",
            "HÃ´tes = 2^(bits hÃ´te) - 2",
          ],
        },
        "subnet info": {
          response: [
            `  RÃ©seau    : ${subnet.network}`,
            `  Masque    : ${subnet.mask}`,
            `  CIDR      : ${subnet.cidr}`,
            `  Broadcast : ${subnet.broadcast}`,
            "",
            "â†’ Combien d'hÃ´tes utilisables ? Tapez 'answer <nombre>'",
          ],
        },
      },
      defaultResponse: (input) => {
        const m = input.match(/^calc \/(\d+)$/);
        if (m) {
          const p = parseInt(m[1]);
          if (p < 0 || p > 32) return ["âœ— CIDR doit Ãªtre entre 0 et 32."];
          const bits = 32 - p;
          const hosts = Math.pow(2, bits) - 2;
          return [
            `  /${p} â†’ ${bits} bits hÃ´te`,
            `  2^${bits} - 2 = ${hosts} hÃ´tes utilisables`,
          ];
        }
        const a = input.match(/^answer (\d+)$/);
        if (a) {
          if (a[1] === subnet.hosts) return null; // win handled by checkWin
          return [`âœ— Incorrect. Indice : masque ${subnet.mask}, formule 2^(bits hÃ´te) - 2`];
        }
        return null;
      },
      checkWin: (input) => {
        const m = input.match(/^answer (\d+)$/);
        return m && m[1] === subnet.hosts;
      },
      winResponse: [
        `âœ“ CORRECT ! ${subnet.hosts} hÃ´tes utilisables sur un ${subnet.cidr}`,
        "",
        "Le subnetting est la BASE de l'architecture rÃ©seau.",
        "â†’ Niveau suivant dÃ©bloquÃ© !",
      ],
    },

    // â”€â”€â”€ LEVEL 3: DNS â”€â”€â”€
    {
      id: 3,
      title: "RÃ‰SOLUTION DNS",
      topic: "DNS",
      mission: `RÃ©solvez le domaine ${dns.domain}. Utilisez 'nslookup' et 'dig' pour trouver l'IP, puis 'answer <ip>'.`,
      hint: `Tapez 'nslookup ${dns.domain}' ou 'dig ${dns.domain}'. L'IP est ${dns.ip}.`,
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  nslookup <dom>  - RÃ©solution DNS simple      â•‘",
            "â•‘  dig <dom>       - RÃ©solution DNS dÃ©taillÃ©e   â•‘",
            "â•‘  answer <ip>     - Donner l'IP trouvÃ©e        â•‘",
            "â•‘  explain         - Comprendre le DNS          â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        explain: {
          response: [
            "ğŸ“– DNS (Domain Name System)",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "Le DNS traduit les noms de domaine en adresses IP.",
            "",
            "HiÃ©rarchie de rÃ©solution :",
            "  1. Cache local (navigateur, OS)",
            "  2. Serveur DNS rÃ©cursif (FAI ou 8.8.8.8)",
            "  3. Serveur racine â†’ .fr â†’ domaine",
            "  4. Serveur autoritaire du domaine",
            "",
            "Types d'enregistrements :",
            "  A     : domaine â†’ IPv4",
            "  AAAA  : domaine â†’ IPv6",
            "  CNAME : alias â†’ autre domaine",
            "  MX    : serveur mail",
            "  NS    : serveur DNS autoritaire",
            "  TXT   : donnÃ©es texte (SPF, DKIM...)",
          ],
        },
      },
      defaultResponse: (input) => {
        if (input === `nslookup ${dns.domain}`) {
          return [
            `Server:    8.8.8.8`,
            `Address:   8.8.8.8#53`,
            "",
            `Non-authoritative answer:`,
            `Name:    ${dns.domain}`,
            `Address: ${dns.ip}`,
            "",
            `â†’ Tapez 'answer ${dns.ip}' pour valider.`,
          ];
        }
        if (input === `dig ${dns.domain}`) {
          return [
            `;; ANSWER SECTION:`,
            `${dns.domain}.  300  IN  ${dns.type}  ${dns.ip}`,
            "",
            `;; Query time: 12 msec`,
            `;; SERVER: 8.8.8.8#53`,
            `;; MSG SIZE rcvd: 58`,
            "",
            `â†’ Record ${dns.type} trouvÃ© ! Tapez 'answer ${dns.ip}'`,
          ];
        }
        if (input.startsWith("nslookup ") || input.startsWith("dig ")) {
          return ["âœ— Domaine inconnu. VÃ©rifiez le nom exact dans la mission."];
        }
        const a = input.match(/^answer (.+)$/);
        if (a) {
          if (a[1] === dns.ip) return null;
          return [`âœ— Ce n'est pas la bonne IP. Utilisez nslookup ou dig sur ${dns.domain}`];
        }
        return null;
      },
      checkWin: (input) => {
        const m = input.match(/^answer (.+)$/);
        return m && m[1] === dns.ip;
      },
      winResponse: [
        `âœ“ CORRECT ! ${dns.domain} â†’ ${dns.ip}`,
        "",
        "Le DNS est le \"annuaire\" d'Internet.",
        "Sans DNS, il faudrait retenir toutes les IP par cÅ“ur !",
        "â†’ Niveau suivant dÃ©bloquÃ© !",
      ],
    },

    // â”€â”€â”€ LEVEL 4: DHCP â”€â”€â”€
    {
      id: 4,
      title: "CONFIGURATION DHCP",
      topic: "DHCP",
      mission: "Un nouveau PC n'a pas d'IP. Configurez le serveur DHCP pour lui attribuer une adresse. Suivez le processus DORA.",
      hint: "Le processus DHCP = DORA : Discover â†’ Offer â†’ Request â†’ Acknowledge. Tapez 'dora' pour lancer.",
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  dora          - Lancer le processus DHCP     â•‘",
            "â•‘  pool          - Voir le pool d'adresses      â•‘",
            "â•‘  leases        - Voir les baux actifs         â•‘",
            "â•‘  config        - Voir la config DHCP          â•‘",
            "â•‘  explain       - Comprendre le DHCP           â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        explain: {
          response: [
            "ğŸ“– DHCP (Dynamic Host Configuration Protocol)",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "Le DHCP attribue automatiquement les configs rÃ©seau.",
            "",
            "Processus DORA :",
            "  1. DISCOVER : Le client envoie un broadcast",
            "     'Qui peut me donner une IP ?'",
            "  2. OFFER : Le serveur DHCP propose une IP",
            "  3. REQUEST : Le client accepte l'offre",
            "  4. ACK : Le serveur confirme le bail (lease)",
            "",
            "Le bail a une durÃ©e limitÃ©e (ex: 24h).",
            "Le client doit renouveler avant expiration.",
            "",
            "Le serveur fournit : IP, masque, gateway, DNS",
          ],
        },
        pool: {
          response: [
            "  DHCP Pool: 192.168.1.100 â†’ 192.168.1.200",
            "  Masque   : 255.255.255.0",
            "  Gateway  : 192.168.1.1",
            "  DNS      : 8.8.8.8, 1.1.1.1",
            "  Bail     : 86400s (24h)",
            "",
            "  Disponibles: 97/100",
          ],
        },
        leases: {
          response: [
            "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "  â”‚ IP                â”‚ MAC               â”‚ EXPIRE   â”‚",
            "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "  â”‚ 192.168.1.101     â”‚ aa:bb:cc:11:22:33 â”‚ 23:14:02 â”‚",
            "  â”‚ 192.168.1.102     â”‚ dd:ee:ff:44:55:66 â”‚ 18:45:30 â”‚",
            "  â”‚ 192.168.1.103     â”‚ 11:22:33:aa:bb:cc â”‚ 12:00:15 â”‚",
            "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
          ],
        },
        config: {
          response: [
            "  dhcp-server {",
            "    interface eth0;",
            "    range 192.168.1.100 192.168.1.200;",
            "    subnet-mask 255.255.255.0;",
            "    default-gateway 192.168.1.1;",
            "    dns-server 8.8.8.8, 1.1.1.1;",
            "    lease-time 86400;",
            "  }",
          ],
        },
        dora: {
          response: [
            "âŸ³ Processus DHCP DORA en cours...",
            "",
            "  â‘  DISCOVER â†’ Client (ff:ff:ff:ff:ff:ff) broadcast",
            "    'Je cherche un serveur DHCP !'",
            "",
            "  â‘¡ OFFER â† Serveur propose 192.168.1.104",
            "    + masque 255.255.255.0",
            "    + gateway 192.168.1.1",
            "    + DNS 8.8.8.8",
            "",
            "  â‘¢ REQUEST â†’ Client accepte 192.168.1.104",
            "    'Je prends cette IP !'",
            "",
            "  â‘£ ACK â† Serveur confirme le bail",
            "    DurÃ©e: 24 heures",
            "",
            "âœ“ PC configurÃ© ! IP 192.168.1.104 attribuÃ©e.",
            "",
            "â†’ Tapez 'verify' pour vÃ©rifier la configuration.",
          ],
        },
        verify: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  VÃ‰RIFICATION CONFIG RÃ‰SEAU - Nouveau PC      â•‘",
            "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
            "â•‘  IP       : 192.168.1.104        âœ“           â•‘",
            "â•‘  Masque   : 255.255.255.0        âœ“           â•‘",
            "â•‘  Gateway  : 192.168.1.1          âœ“           â•‘",
            "â•‘  DNS      : 8.8.8.8              âœ“           â•‘",
            "â•‘  Bail     : 86400s               âœ“           â•‘",
            "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
            "â•‘  PING gateway : âœ“ OK                         â•‘",
            "â•‘  PING DNS     : âœ“ OK                         â•‘",
            "â•‘  RÃ©solution   : âœ“ google.fr â†’ 142.250.75.227 â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
            "",
            "âœ“ Configuration DHCP fonctionnelle !",
            "â†’ Niveau suivant dÃ©bloquÃ© !",
          ],
          nextLevel: true,
        },
      },
    },

    // â”€â”€â”€ LEVEL 5: FIREWALL â”€â”€â”€
    {
      id: 5,
      title: "RÃˆGLES FIREWALL",
      topic: "Firewall & SÃ©curitÃ©",
      mission: `Audit de sÃ©curitÃ© : le port ${fw.port} (${fw.service}) est ouvert sur le serveur web. C'est dangereux ! Bloquez-le avec 'iptables'.`,
      hint: `Tapez 'iptables -A INPUT -p tcp --dport ${fw.port} -j DROP' pour bloquer le port ${fw.port}.`,
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  iptables -L       - Lister les rÃ¨gles        â•‘",
            "â•‘  iptables -A INPUT - Ajouter une rÃ¨gle        â•‘",
            "â•‘  nmap 192.168.1.10 - Scanner les ports         â•‘",
            "â•‘  explain           - Comprendre les firewalls  â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        explain: {
          response: [
            "ğŸ“– FIREWALL (PARE-FEU)",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "Un firewall filtre le trafic rÃ©seau selon des rÃ¨gles.",
            "",
            "ChaÃ®nes iptables :",
            "  INPUT   : trafic entrant vers la machine",
            "  OUTPUT  : trafic sortant de la machine",
            "  FORWARD : trafic transitant (routeur)",
            "",
            "Actions :",
            "  ACCEPT : autoriser le paquet",
            "  DROP   : supprimer silencieusement",
            "  REJECT : refuser avec message d'erreur",
            "",
            "Syntaxe : iptables -A <chaÃ®ne> -p <proto> --dport <port> -j <action>",
            "",
            "Principe du moindre privilÃ¨ge :",
            "â†’ N'ouvrir QUE les ports nÃ©cessaires !",
          ],
        },
        "nmap 192.168.1.10": {
          response: [
            "Starting Nmap scan on 192.168.1.10...",
            "",
            "  PORT     STATE  SERVICE",
            "  22/tcp   open   SSH",
            "  80/tcp   open   HTTP",
            "  443/tcp  open   HTTPS",
            `  ${fw.port}/tcp   open   ${fw.service}  âš  DANGER`,
            "",
            `âš  Le port ${fw.port} (${fw.service}) est exposÃ© sur un serveur web !`,
            `â†’ Bloquez-le : iptables -A INPUT -p tcp --dport ${fw.port} -j DROP`,
          ],
        },
        "iptables -L": {
          response: [
            "Chain INPUT (policy ACCEPT)",
            "  ACCEPT  tcp  --  anywhere  dport 22   (SSH)",
            "  ACCEPT  tcp  --  anywhere  dport 80   (HTTP)",
            "  ACCEPT  tcp  --  anywhere  dport 443  (HTTPS)",
            `  âš  Pas de rÃ¨gle pour bloquer ${fw.port}/${fw.service} !`,
          ],
        },
        [`iptables -A INPUT -p tcp --dport ${fw.port} -j DROP`]: {
          response: [
            `âœ“ RÃ¨gle ajoutÃ©e : BLOQUER TCP port ${fw.port} (${fw.service})`,
            "",
            "Chain INPUT (policy ACCEPT) â€” mise Ã  jour :",
            "  ACCEPT  tcp  dport 22   (SSH)",
            "  ACCEPT  tcp  dport 80   (HTTP)",
            "  ACCEPT  tcp  dport 443  (HTTPS)",
            `  DROP    tcp  dport ${fw.port}  (${fw.service}) â† NOUVEAU`,
            "",
            `âœ“ Port ${fw.port} bloquÃ© ! Le serveur est sÃ©curisÃ©.`,
            "â†’ Niveau suivant dÃ©bloquÃ© !",
          ],
          nextLevel: true,
        },
      },
      defaultResponse: (input) => {
        if (input.startsWith("iptables -A")) {
          return [`âœ— Syntaxe incorrecte. Essayez : iptables -A INPUT -p tcp --dport ${fw.port} -j DROP`];
        }
        return null;
      },
    },

    // â”€â”€â”€ LEVEL 6: VLAN â”€â”€â”€
    {
      id: 6,
      title: "SEGMENTATION VLAN",
      topic: "VLAN & Segmentation",
      mission: `CrÃ©ez le VLAN ${vlan.id} (${vlan.name}) sur le switch pour isoler le trafic. Configurez-le avec le sous-rÃ©seau ${vlan.subnet}.`,
      hint: `Tapez 'vlan create ${vlan.id} ${vlan.name}' puis 'vlan assign ${vlan.id} ${vlan.subnet}'.`,
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  vlan list              - Lister les VLANs    â•‘",
            "â•‘  vlan create <id> <nom> - CrÃ©er un VLAN       â•‘",
            "â•‘  vlan assign <id> <sub> - Assigner sous-rÃ©seauâ•‘",
            "â•‘  vlan verify            - VÃ©rifier la config  â•‘",
            "â•‘  explain                - Comprendre les VLAN â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        explain: {
          response: [
            "ğŸ“– VLAN (Virtual LAN)",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "Un VLAN segmente un rÃ©seau physique en rÃ©seaux logiques.",
            "",
            "Pourquoi ?",
            "  â€¢ SÃ©curitÃ© : isoler les dÃ©partements",
            "  â€¢ Performance : rÃ©duire le broadcast",
            "  â€¢ Organisation : sÃ©parer admin/dev/guest",
            "",
            "Fonctionnement :",
            "  â€¢ Chaque VLAN a un ID (1-4094)",
            "  â€¢ Les ports du switch sont assignÃ©s Ã  un VLAN",
            "  â€¢ Trunk = liaison inter-switch multi-VLAN (802.1Q)",
            "  â€¢ Inter-VLAN routing = via routeur ou switch L3",
            "",
            "Sans VLAN, tout le monde est dans le mÃªme broadcast domain !",
          ],
        },
        "vlan list": {
          response: [
            "  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "  â”‚ ID   â”‚ NOM        â”‚ SOUS-RÃ‰SEAU          â”‚",
            "  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "  â”‚ 1    â”‚ DEFAULT    â”‚ 192.168.1.0/24       â”‚",
            "  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
            "",
            `â†’ CrÃ©ez le VLAN ${vlan.id} : vlan create ${vlan.id} ${vlan.name}`,
          ],
        },
      },
      defaultResponse: (input) => {
        if (input === `vlan create ${vlan.id} ${vlan.name}`) {
          return [
            `âœ“ VLAN ${vlan.id} (${vlan.name}) crÃ©Ã©.`,
            "",
            `â†’ Assignez le sous-rÃ©seau : vlan assign ${vlan.id} ${vlan.subnet}`,
          ];
        }
        if (input === `vlan assign ${vlan.id} ${vlan.subnet}`) {
          return [
            `âœ“ Sous-rÃ©seau ${vlan.subnet} assignÃ© au VLAN ${vlan.id}.`,
            "",
            "â†’ Tapez 'vlan verify' pour valider la configuration.",
          ];
        }
        if (input === "vlan verify") return null; // handled by checkWin
        if (input.startsWith("vlan create") || input.startsWith("vlan assign")) {
          return [`âœ— VÃ©rifiez les paramÃ¨tres. VLAN ID: ${vlan.id}, Nom: ${vlan.name}, Subnet: ${vlan.subnet}`];
        }
        return null;
      },
      checkWin: (input) => input === "vlan verify",
      winResponse: [
        "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
        "â•‘  VÃ‰RIFICATION VLAN                            â•‘",
        "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£",
        `â•‘  VLAN ${vlan.id} (${vlan.name})${" ".repeat(Math.max(0, 32 - vlan.name.length - vlan.id.length))}âœ“           â•‘`,
        `â•‘  Subnet: ${vlan.subnet}${" ".repeat(Math.max(0, 28 - vlan.subnet.length))}âœ“           â•‘`,
        "â•‘  Isolation broadcast       âœ“                 â•‘",
        "â•‘  Trunk 802.1Q              âœ“                 â•‘",
        "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "",
        "âœ“ VLAN correctement configurÃ© !",
        "â†’ Niveau suivant dÃ©bloquÃ© !",
      ],
    },

    // â”€â”€â”€ LEVEL 7: FINAL CHALLENGE â”€â”€â”€
    {
      id: 7,
      title: "INCIDENT RÃ‰SEAU CRITIQUE",
      topic: "Troubleshooting Complet",
      mission: "ALERTE ! Le rÃ©seau de production est down. Diagnostiquez et rÃ©parez en utilisant toutes vos compÃ©tences. Tapez 'status' pour commencer.",
      hint: "Suivez les Ã©tapes : status â†’ ping gateway â†’ check dns â†’ check dhcp â†’ fix dns â†’ fix dhcp â†’ restart",
      fixedDns: false,
      fixedDhcp: false,
      commands: {
        help: {
          response: [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            "â•‘  status        - Ã‰tat des services            â•‘",
            "â•‘  ping <ip>     - Tester la connectivitÃ©       â•‘",
            "â•‘  check dns     - VÃ©rifier le DNS              â•‘",
            "â•‘  check dhcp    - VÃ©rifier le DHCP             â•‘",
            "â•‘  fix dns       - RÃ©parer le DNS               â•‘",
            "â•‘  fix dhcp      - RÃ©parer le DHCP              â•‘",
            "â•‘  restart       - RedÃ©marrer les services      â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          ],
        },
        status: {
          response: [
            "âš  RAPPORT D'INCIDENT â€” RÃ‰SEAU PRODUCTION",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "  ConnectivitÃ© LAN  : âš  DÃ‰GRADÃ‰E",
            "  Service DNS       : âœ— DOWN",
            "  Service DHCP      : âœ— DOWN",
            "  Firewall          : âœ“ OK",
            "  Switches          : âœ“ OK",
            "",
            "â†’ 2 services critiques down ! Investiguez chacun.",
          ],
        },
        "ping 192.168.1.1": {
          response: [
            "PING 192.168.1.1 : 64 bytes, ttl=64, time=1.1ms",
            "âœ“ Gateway joignable â€” le lien physique est OK.",
          ],
        },
        "check dns": {
          response: [
            "âŸ³ VÃ©rification DNS...",
            "",
            "  Serveur DNS primaire  : 192.168.1.10  âœ— UNREACHABLE",
            "  Serveur DNS secondaire: 8.8.8.8       âœ“ OK",
            "  Config: /etc/resolv.conf pointe vers 192.168.1.10 uniquement",
            "",
            "âš  Le DNS primaire est down et aucun fallback configurÃ© !",
            "â†’ Tapez 'fix dns' pour corriger.",
          ],
        },
        "check dhcp": {
          response: [
            "âŸ³ VÃ©rification DHCP...",
            "",
            "  Service dhcpd : âœ— STOPPED (crashed)",
            "  DerniÃ¨re erreur : 'pool exhausted â€” no available leases'",
            "  Leases actifs : 254/254 (100% utilisÃ© !)",
            "",
            "âš  Le pool DHCP est plein ! Aucune nouvelle IP disponible.",
            "â†’ Tapez 'fix dhcp' pour corriger.",
          ],
        },
        "fix dns": {
          response: [
            "âŸ³ RÃ©paration DNS...",
            "",
            "  Mise Ã  jour /etc/resolv.conf :",
            "    nameserver 192.168.1.10",
            "    nameserver 8.8.8.8        â† AJOUTÃ‰ (fallback)",
            "    nameserver 1.1.1.1        â† AJOUTÃ‰ (fallback)",
            "",
            "  RedÃ©marrage bind9... âœ“ OK",
            "  Test rÃ©solution google.fr... âœ“ 142.250.75.227",
            "",
            "âœ“ DNS rÃ©parÃ© avec fallback redondant !",
          ],
        },
        "fix dhcp": {
          response: [
            "âŸ³ RÃ©paration DHCP...",
            "",
            "  Nettoyage baux expirÃ©s... 47 baux libÃ©rÃ©s",
            "  Extension pool : 192.168.1.100 â†’ 192.168.2.200",
            "  RÃ©duction lease time : 86400s â†’ 28800s (8h)",
            "  RedÃ©marrage dhcpd... âœ“ OK",
            "",
            "âœ“ DHCP rÃ©parÃ© ! Pool Ã©tendu, baux nettoyÃ©s.",
          ],
        },
        restart: {
          response: [
            "âŸ³ RedÃ©marrage des services rÃ©seau...",
            "",
            "  [1/5] Networking    ... âœ“",
            "  [2/5] DNS (bind9)   ... âœ“",
            "  [3/5] DHCP (dhcpd)  ... âœ“",
            "  [4/5] Firewall      ... âœ“",
            "  [5/5] Monitoring    ... âœ“",
            "",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            "  TOUS LES SERVICES SONT OPÃ‰RATIONNELS !",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          ],
          nextLevel: true,
        },
      },
    },

    // â”€â”€â”€ VICTORY â”€â”€â”€
    {
      id: 8,
      title: "MISSION ACCOMPLIE",
      topic: "Victoire",
      mission: "",
      hint: "",
      commands: {},
      victory: true,
    },
  ];
}

// â”€â”€â”€ ASCII art â”€â”€â”€
const LOGO_ASCII = [
  "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
  "  â”‚    _   _ _____ _____   ___   ____ _____ â”‚",
  "  â”‚   | \\ | | ____|_   _| / _ \\ |  _ \\_   _â”‚â”‚",
  "  â”‚   |  \\| |  _|   | |  | | | || |_) || |  â”‚",
  "  â”‚   | |\\  | |___  | |  | |_| ||  __/ | |  â”‚",
  "  â”‚   |_| \\_|_____| |_|   \\___/ |_|    |_|  â”‚",
  "  â”‚                                          â”‚",
  "  â”‚        NETWORK OPERATIONS TRAINING       â”‚",
  "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
];

const VICTORY_ASCII = [
  "",
  "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
  "  â•‘                                               â•‘",
  "  â•‘      ğŸ†  MISSION ACCOMPLIE !  ğŸ†              â•‘",
  "  â•‘                                               â•‘",
  "  â•‘   Vous maÃ®trisez les fondamentaux rÃ©seau :    â•‘",
  "  â•‘                                               â•‘",
  "  â•‘   âœ“ Scan & dÃ©couverte rÃ©seau                  â•‘",
  "  â•‘   âœ“ Diagnostic avec ping & traceroute         â•‘",
  "  â•‘   âœ“ Calcul de sous-rÃ©seaux (subnetting)       â•‘",
  "  â•‘   âœ“ RÃ©solution DNS                            â•‘",
  "  â•‘   âœ“ Configuration DHCP (processus DORA)       â•‘",
  "  â•‘   âœ“ RÃ¨gles firewall (iptables)                â•‘",
  "  â•‘   âœ“ Segmentation VLAN                         â•‘",
  "  â•‘   âœ“ Troubleshooting d'incident complet        â•‘",
  "  â•‘                                               â•‘",
  "  â•‘   Grade : INGÃ‰NIEUR RÃ‰SEAU JUNIOR             â•‘",
  "  â•‘                                               â•‘",
  "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
  "",
  "  Tapez 'restart' pour rejouer avec de nouvelles valeurs.",
];

// â”€â”€â”€ Main Component â”€â”€â”€
export default function NetworkGame() {
  const [levels, setLevels] = useState(() => generateLevels());
  const [level, setLevel] = useState(0);
  const [lines, setLines] = useState([]);
  const [input, setInput] = useState("");
  const [showIntro, setShowIntro] = useState(true);
  const [hintsUsed, setHintsUsed] = useState(0);
  const [commandHistory, setCommandHistory] = useState([]);
  const [historyIndex, setHistoryIndex] = useState(-1);
  const [startTime] = useState(Date.now());
  const [score, setScore] = useState(0);

  const inputRef = useRef(null);
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [lines]);

  const focusInput = useCallback(() => {
    if (inputRef.current) inputRef.current.focus();
  }, []);

  useEffect(() => {
    focusInput();
  }, [showIntro, focusInput]);

  const addLines = useCallback((newLines) => {
    setLines((prev) => [...prev, ...newLines]);
  }, []);

  const processCommand = useCallback(
    (cmd) => {
      const trimmed = cmd.trim().toLowerCase();
      if (!trimmed) return;

      setCommandHistory((prev) => [...prev, trimmed]);
      setHistoryIndex(-1);
      addLines([``, `â”Œâ”€ root@netops:~$`, `â””â”€â–¸ ${cmd.trim()}`]);

      const currentLevel = levels[level];

      // Global commands
      if (trimmed === "clear") {
        setLines([]);
        return;
      }
      if (trimmed === "mission") {
        addLines(["", `ğŸ“‹ MISSION : ${currentLevel.mission}`]);
        return;
      }
      if (trimmed === "hint") {
        setHintsUsed((h) => h + 1);
        addLines(["", `ğŸ’¡ INDICE : ${currentLevel.hint}`]);
        return;
      }
      if (trimmed === "score") {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        addLines([
          "",
          `ğŸ“Š Score: ${score} pts | Niveau: ${level}/${levels.length - 2} | Hints: ${hintsUsed} | Temps: ${Math.floor(elapsed / 60)}m${elapsed % 60}s`,
        ]);
        return;
      }
      if (trimmed === "restart" && currentLevel.victory) {
        const newLevels = generateLevels();
        setLevels(newLevels);
        setLevel(0);
        setLines([]);
        setHintsUsed(0);
        setScore(0);
        setShowIntro(true);
        return;
      }

      // Check custom checkWin
      if (currentLevel.checkWin && currentLevel.checkWin(trimmed)) {
        addLines(["", ...currentLevel.winResponse]);
        setScore((s) => s + 150);
        setTimeout(() => {
          setLevel((l) => l + 1);
          addLines(["", "â”".repeat(50), ""]);
          const next = levels[level + 1];
          if (next && !next.victory) {
            addLines([
              `â¬¡ NIVEAU ${level + 1} â€” ${next.title}`,
              `  Sujet : ${next.topic}`,
              `  ${next.mission}`,
              "",
              "  Tapez 'help' pour les commandes disponibles.",
            ]);
          } else if (next && next.victory) {
            addLines(VICTORY_ASCII);
          }
        }, 500);
        return;
      }

      // Check defaultResponse
      if (currentLevel.defaultResponse) {
        const resp = currentLevel.defaultResponse(trimmed);
        if (resp) {
          addLines(["", ...resp]);
          return;
        }
      }

      // Check static commands
      if (currentLevel.commands[trimmed]) {
        const cmdDef = currentLevel.commands[trimmed];
        addLines(["", ...cmdDef.response]);
        if (cmdDef.nextLevel) {
          setScore((s) => s + 100);
          setTimeout(() => {
            setLevel((l) => l + 1);
            addLines(["", "â”".repeat(50), ""]);
            const next = levels[level + 1];
            if (next && !next.victory) {
              addLines([
                `â¬¡ NIVEAU ${level + 1} â€” ${next.title}`,
                `  Sujet : ${next.topic}`,
                `  ${next.mission}`,
                "",
                "  Tapez 'help' pour les commandes disponibles.",
              ]);
            } else if (next && next.victory) {
              addLines(VICTORY_ASCII);
            }
          }, 500);
        }
        return;
      }

      // Unknown command
      addLines([
        "",
        `âœ— Commande inconnue : '${cmd.trim()}'`,
        "  Tapez 'help' pour voir les commandes disponibles.",
      ]);
    },
    [level, levels, addLines, hintsUsed, score, startTime]
  );

  const handleKeyDown = useCallback(
    (e) => {
      if (e.key === "Enter") {
        processCommand(input);
        setInput("");
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (commandHistory.length > 0) {
          const newIndex = historyIndex === -1 ? commandHistory.length - 1 : Math.max(0, historyIndex - 1);
          setHistoryIndex(newIndex);
          setInput(commandHistory[newIndex]);
        }
      } else if (e.key === "ArrowDown") {
        e.preventDefault();
        if (historyIndex !== -1) {
          const newIndex = historyIndex + 1;
          if (newIndex >= commandHistory.length) {
            setHistoryIndex(-1);
            setInput("");
          } else {
            setHistoryIndex(newIndex);
            setInput(commandHistory[newIndex]);
          }
        }
      }
    },
    [input, processCommand, commandHistory, historyIndex]
  );

  // â”€â”€â”€ INTRO SCREEN â”€â”€â”€
  if (showIntro) {
    return (
      <div
        style={{
          minHeight: "100vh",
          background: "linear-gradient(180deg, #020810 0%, #0a1628 50%, #020810 100%)",
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace",
          overflow: "hidden",
          position: "relative",
        }}
      >
        {/* Grid background */}
        <div
          style={{
            position: "absolute",
            inset: 0,
            backgroundImage:
              "linear-gradient(rgba(0,180,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,180,255,0.03) 1px, transparent 1px)",
            backgroundSize: "40px 40px",
          }}
        />
        {/* Glow */}
        <div
          style={{
            position: "absolute",
            top: "30%",
            left: "50%",
            transform: "translate(-50%, -50%)",
            width: "600px",
            height: "400px",
            background: "radial-gradient(ellipse, rgba(0,150,255,0.08) 0%, transparent 70%)",
            pointerEvents: "none",
          }}
        />
        <div style={{ textAlign: "center", zIndex: 1, maxWidth: "700px", padding: "20px" }}>
          <pre
            style={{
              color: "#00b4ff",
              fontSize: "13px",
              lineHeight: "1.4",
              textShadow: "0 0 20px rgba(0,180,255,0.4)",
              marginBottom: "30px",
            }}
          >
            {LOGO_ASCII.join("\n")}
          </pre>
          <div
            style={{
              color: "#5a7a9a",
              fontSize: "13px",
              lineHeight: "1.8",
              marginBottom: "35px",
            }}
          >
            Vous Ãªtes le nouveau technicien rÃ©seau.
            <br />
            Traversez <span style={{ color: "#00b4ff" }}>7 niveaux</span> pour maÃ®triser les fondamentaux :
            <div style={{ marginTop: "14px", color: "#3a5a7a", fontSize: "12px" }}>
              â–¸ Scan rÃ©seau &amp; connectivitÃ© Â· â–¸ Ping &amp; Traceroute Â· â–¸ Subnetting
              <br />
              â–¸ DNS Â· â–¸ DHCP Â· â–¸ Firewall Â· â–¸ VLAN Â· â–¸ Troubleshooting
            </div>
          </div>
          <button
            onClick={() => {
              setShowIntro(false);
              addLines([
                ...LOGO_ASCII,
                "",
                "  SystÃ¨me initialisÃ©. Bienvenue, technicien.",
                "",
                `â¬¡ NIVEAU 0 â€” ${levels[0].title}`,
                `  ${levels[0].mission}`,
                "",
              ]);
            }}
            style={{
              background: "transparent",
              color: "#00b4ff",
              border: "1px solid #00b4ff",
              padding: "14px 50px",
              fontFamily: "inherit",
              fontSize: "14px",
              fontWeight: "bold",
              cursor: "pointer",
              letterSpacing: "3px",
              borderRadius: "2px",
              transition: "all 0.3s ease",
              boxShadow: "0 0 20px rgba(0,180,255,0.15)",
            }}
            onMouseOver={(e) => {
              e.target.style.background = "#00b4ff";
              e.target.style.color = "#020810";
              e.target.style.boxShadow = "0 0 40px rgba(0,180,255,0.4)";
            }}
            onMouseOut={(e) => {
              e.target.style.background = "transparent";
              e.target.style.color = "#00b4ff";
              e.target.style.boxShadow = "0 0 20px rgba(0,180,255,0.15)";
            }}
          >
            CONNECTER AU RÃ‰SEAU
          </button>
        </div>
      </div>
    );
  }

  const currentLevel = levels[level];

  // â”€â”€â”€ TERMINAL â”€â”€â”€
  return (
    <div
      style={{
        minHeight: "100vh",
        background: "#020810",
        fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace",
        display: "flex",
        flexDirection: "column",
        position: "relative",
        overflow: "hidden",
      }}
      onClick={focusInput}
    >
      {/* Grid bg */}
      <div
        style={{
          position: "absolute",
          inset: 0,
          backgroundImage:
            "linear-gradient(rgba(0,180,255,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(0,180,255,0.015) 1px, transparent 1px)",
          backgroundSize: "40px 40px",
          pointerEvents: "none",
        }}
      />

      {/* Header */}
      <div
        style={{
          background: "rgba(5,12,30,0.95)",
          borderBottom: "1px solid rgba(0,180,255,0.15)",
          padding: "10px 20px",
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          zIndex: 10,
          backdropFilter: "blur(10px)",
        }}
      >
        <div style={{ display: "flex", alignItems: "center", gap: "16px" }}>
          <span style={{ color: "#00b4ff", fontSize: "13px", fontWeight: "bold", letterSpacing: "1px" }}>
            â¬¡ NETÂ·OPS
          </span>
          <span style={{ color: "#1a2a3a" }}>â”‚</span>
          <span style={{ color: "#f0c040", fontSize: "12px" }}>
            LVL {Math.min(level, levels.length - 2)}/{levels.length - 2}
          </span>
          <span style={{ color: "#1a2a3a" }}>â”‚</span>
          <span style={{ color: "#3a7aaa", fontSize: "12px" }}>{currentLevel.title}</span>
        </div>
        <div style={{ display: "flex", gap: "14px", alignItems: "center" }}>
          <span style={{ color: "#2a4a6a", fontSize: "11px" }}>SCORE: {score}</span>
          <span style={{ color: "#2a4a6a", fontSize: "11px" }}>HINTS: {hintsUsed}</span>
          <div style={{ display: "flex", gap: "4px" }}>
            {levels.slice(0, -1).map((_, i) => (
              <div
                key={i}
                style={{
                  width: "8px",
                  height: "8px",
                  borderRadius: "50%",
                  background: i < level ? "#00b4ff" : i === level ? "#f0c040" : "#1a2a3a",
                  boxShadow: i < level ? "0 0 6px rgba(0,180,255,0.5)" : "none",
                  transition: "all 0.3s ease",
                }}
              />
            ))}
          </div>
        </div>
      </div>

      {/* Topic bar */}
      {currentLevel.topic && !currentLevel.victory && (
        <div
          style={{
            background: "rgba(0,180,255,0.04)",
            borderBottom: "1px solid rgba(0,180,255,0.08)",
            padding: "6px 20px",
            display: "flex",
            justifyContent: "space-between",
            fontSize: "11px",
            zIndex: 10,
          }}
        >
          <span style={{ color: "#3a6a8a" }}>ğŸ“¡ {currentLevel.topic}</span>
          <span style={{ color: "#2a4a6a" }}>
            {currentLevel.mission && currentLevel.mission.length > 80
              ? currentLevel.mission.substring(0, 77) + "..."
              : currentLevel.mission}
          </span>
        </div>
      )}

      {/* Terminal body */}
      <div
        ref={scrollRef}
        style={{
          flex: 1,
          overflowY: "auto",
          padding: "16px 20px",
          paddingBottom: "80px",
          zIndex: 1,
        }}
      >
        {lines.map((line, i) => {
          let color = "#7a9ab8";
          if (line.startsWith("âœ“")) color = "#00cc66";
          else if (line.startsWith("âœ—") || line.startsWith("âš ")) color = "#ff4444";
          else if (line.startsWith("â†’")) color = "#00b4ff";
          else if (line.startsWith("âŸ³")) color = "#f0c040";
          else if (line.startsWith("ğŸ“–") || line.startsWith("â”")) color = "#00b4ff";
          else if (line.startsWith("â”Œâ”€ root")) color = "#3a6a8a";
          else if (line.startsWith("â””â”€â–¸")) color = "#00b4ff";
          else if (line.startsWith("  â•”") || line.startsWith("  â•‘") || line.startsWith("  â• ") || line.startsWith("  â•š"))
            color = "#4a7a9a";
          else if (line.startsWith("â¬¡")) color = "#f0c040";

          return (
            <div
              key={i}
              style={{
                color,
                fontSize: "13px",
                lineHeight: "1.6",
                whiteSpace: "pre",
                minHeight: line === "" ? "8px" : "auto",
              }}
            >
              {line}
            </div>
          );
        })}
      </div>

      {/* Input bar */}
      <div
        style={{
          position: "fixed",
          bottom: 0,
          left: 0,
          right: 0,
          background: "rgba(5,12,30,0.97)",
          borderTop: "1px solid rgba(0,180,255,0.15)",
          padding: "12px 20px",
          display: "flex",
          alignItems: "center",
          gap: "10px",
          zIndex: 20,
          backdropFilter: "blur(10px)",
        }}
      >
        <span style={{ color: "#00b4ff", fontSize: "13px", fontWeight: "bold" }}>root@netops:~$</span>
        <input
          ref={inputRef}
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={handleKeyDown}
          autoFocus
          spellCheck={false}
          autoComplete="off"
          autoCapitalize="off"
          style={{
            flex: 1,
            background: "transparent",
            border: "none",
            outline: "none",
            color: "#c8dcea",
            fontFamily: "inherit",
            fontSize: "13px",
            caretColor: "#00b4ff",
          }}
          placeholder={currentLevel.victory ? "restart" : "Tapez une commande..."}
        />
      </div>
    </div>
  );
}


        /* --------------------------*/

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NetworkGame />);
    </script>
</body>
</html>
