<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’» DÃ©veloppement Python â€” Challenge Terminal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { height: 100%; width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" src="python-game.jsx"></script>
    <script type="text/babel">
        /* ----------------- */ 
            import { useState, useEffect, useRef, useCallback } from "react";

const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);
const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// â”€â”€â”€ PYTHON EVALUATOR (safe subset) â”€â”€â”€
const pyEval = (code) => {
  try {
    const trimmed = code.trim();
    // Basic print detection
    const printMatch = trimmed.match(/^print\((.+)\)$/);
    if (printMatch) {
      const inner = printMatch[1];
      try {
        const val = Function(`"use strict"; return (${inner})`)();
        return { output: String(val), error: null };
      } catch {
        return { output: inner.replace(/^["']|["']$/g, ""), error: null };
      }
    }
    // Direct expression
    const val = Function(`"use strict"; return (${trimmed})`)();
    return { output: String(val), error: null };
  } catch (e) {
    return { output: null, error: e.message };
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEVEL GENERATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const generateVariablesLevel = () => {
  const challenges = [
    { question: "Quel est le type de la valeur 42 ?", answer: "int", code: "type(42)", hint: "Les nombres entiers sont de type 'int' en Python." },
    { question: "Quel est le type de la valeur 3.14 ?", answer: "float", code: "type(3.14)", hint: "Les nombres dÃ©cimaux sont de type 'float'." },
    { question: "Quel est le type de la valeur \"hello\" ?", answer: "str", code: 'type("hello")', hint: "Les chaÃ®nes de caractÃ¨res entre guillemets sont de type 'str'." },
    { question: "Quel est le type de la valeur True ?", answer: "bool", code: "type(True)", hint: "True et False sont de type 'bool' (boolÃ©en)." },
    { question: "Quel est le type de la valeur [1, 2, 3] ?", answer: "list", code: "type([1,2,3])", hint: "Les crochets [] dÃ©finissent une 'list'." },
  ];
  const ch = pick(challenges);

  return {
    id: "variables",
    title: "VARIABLES & TYPES",
    mission: `${ch.question} RÃ©pondez avec 'answer <type>'.`,
    hint: ch.hint,
    topic: "Variables & Types Python",
    codeExample: ch.code,
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <type>   - RÃ©pondre Ã  la question    â•‘",
          "â•‘  types           - Liste des types Python     â•‘",
          "â•‘  run <code>      - ExÃ©cuter du Python         â•‘",
          "â•‘  example         - Voir un exemple            â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      types: {
        response: [
          "ğŸ“– TYPES PYTHON PRINCIPAUX :",
          "  int    â†’ Entier        (42, -7, 0)",
          "  float  â†’ DÃ©cimal       (3.14, -0.5)",
          "  str    â†’ ChaÃ®ne        (\"hello\", 'world')",
          "  bool   â†’ BoolÃ©en       (True, False)",
          "  list   â†’ Liste         ([1, 2, 3])",
          "  dict   â†’ Dictionnaire  ({\"a\": 1})",
          "  tuple  â†’ Tuple         ((1, 2, 3))",
          "  None   â†’ Rien          (None)",
        ],
      },
      example: {
        response: [
          ">>> x = 42",
          ">>> type(x)",
          "<class 'int'>",
          "",
          ">>> name = \"Python\"",
          ">>> type(name)",
          "<class 'str'>",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim().toLowerCase();
        if (a === ch.answer) return null;
        return [`âœ— Incorrect. ${ch.code} ne retourne pas '${a}'.`];
      }
      if (input.startsWith("run ")) {
        const code = input.slice(4);
        const r = pyEval(code);
        return r.error ? [`âœ— Erreur: ${r.error}`] : [`>>> ${r.output}`];
      }
      return null;
    },
    checkWin: (input) => input.startsWith("answer ") && input.slice(7).trim().toLowerCase() === ch.answer,
    winResponse: [
      `âœ“ Correct ! ${ch.code} â†’ <class '${ch.answer}'>`,
      "",
      "âš  Ã€ RETENIR :",
      "â†’ type() permet de vÃ©rifier le type d'une valeur.",
      "â†’ Python est un langage Ã  typage dynamique.",
      "â†’ Les types dÃ©terminent les opÃ©rations possibles.",
    ],
  };
};

const generateConditionsLevel = (difficulty) => {
  const challenges = {
    "dÃ©butant": [
      { desc: "Ã‰crivez une condition : si x vaut 10, retourner 'oui', sinon 'non'. x = 10.", answer: "oui", variable: "x", value: 10, test: (v) => v === 10 ? "oui" : "non", hint: "if x == 10: â†’ 'oui'. Tapez: answer oui" },
      { desc: "x = 5. Est-ce que x > 3 AND x < 10 ? RÃ©pondez True ou False.", answer: "true", variable: "x", value: 5, test: (v) => v > 3 && v < 10, hint: "5 > 3 est True, 5 < 10 est True. True AND True = ?" },
      { desc: "x = -3. Est-ce que x est positif (x > 0) ? True ou False.", answer: "false", variable: "x", value: -3, test: (v) => v > 0, hint: "-3 > 0 est False." },
    ],
    "intermÃ©diaire": [
      { desc: "x = 15. Que retourne 'pair' si x%2==0, 'impair' sinon ?", answer: "impair", variable: "x", value: 15, hint: "15 % 2 = 1, donc x n'est pas pair." },
      { desc: "x = 0. Que vaut bool(x) en Python ?", answer: "false", variable: "x", value: 0, hint: "En Python, 0 est 'falsy' â†’ bool(0) = False." },
      { desc: "x = \"\". Que vaut bool(x) en Python ?", answer: "false", variable: "x", value: "", hint: "Une chaÃ®ne vide est 'falsy' â†’ bool('') = False." },
    ],
    "expert": [
      { desc: "Que retourne: True + True + False en Python ?", answer: "2", hint: "En Python, True=1 et False=0. Donc 1+1+0=2." },
      { desc: "Que retourne: not not [] en Python ? (True/False)", answer: "false", hint: "[] est falsy â†’ not [] = True â†’ not True = False." },
      { desc: "x=5. Que vaut: 'a' if x>3 else 'b' if x>7 else 'c' ?", answer: "a", hint: "x>3 est True, donc on retourne 'a' directement." },
    ],
  };

  const ch = pick(challenges[difficulty]);

  return {
    id: "conditions",
    title: "CONDITIONS & LOGIQUE",
    mission: `${ch.desc} RÃ©pondez avec 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "Conditions if/else, BoolÃ©ens",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  run <code>      - Tester du Python           â•‘",
          "â•‘  explain         - Cours sur les conditions   â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– CONDITIONS EN PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "if x > 0:",
          "    print('positif')",
          "elif x == 0:",
          "    print('zÃ©ro')",
          "else:",
          "    print('nÃ©gatif')",
          "",
          "OpÃ©rateurs : ==, !=, <, >, <=, >=",
          "Logique : and, or, not",
          "Falsy : 0, '', [], {}, None, False",
          "Ternaire : 'a' if condition else 'b'",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim().toLowerCase();
        if (a === ch.answer.toLowerCase()) return null;
        return [`âœ— Incorrect. RÃ©essayez.`];
      }
      if (input.startsWith("run ")) {
        const r = pyEval(input.slice(4));
        return r.error ? [`âœ— ${r.error}`] : [`>>> ${r.output}`];
      }
      return null;
    },
    checkWin: (input) => input.startsWith("answer ") && input.slice(7).trim().toLowerCase() === ch.answer.toLowerCase(),
    winResponse: [
      `âœ“ Correct ! La rÃ©ponse est : ${ch.answer}`,
      "",
      "âš  Ã€ RETENIR :",
      "â†’ Python Ã©value les conditions de gauche Ã  droite.",
      "â†’ Les valeurs 'falsy' : 0, '', [], {}, None, False.",
      "â†’ L'opÃ©rateur ternaire : valeur_si_vrai if condition else valeur_si_faux.",
    ],
  };
};

const generateLoopsLevel = (difficulty) => {
  const challenges = {
    "dÃ©butant": [
      { desc: "Que fait range(5) ? Donnez la liste des nombres gÃ©nÃ©rÃ©s, sÃ©parÃ©s par des virgules.", answer: "0,1,2,3,4", hint: "range(5) gÃ©nÃ¨re les nombres de 0 Ã  4 (5 exclu)." },
      { desc: "Combien de fois 'for i in range(3)' s'exÃ©cute ?", answer: "3", hint: "range(3) = [0, 1, 2] â†’ 3 itÃ©rations." },
      { desc: "for i in range(1, 4): print(i). Qu'affiche ce code ? (rÃ©ponse: les nombres sÃ©parÃ©s par des virgules)", answer: "1,2,3", hint: "range(1, 4) commence Ã  1 et s'arrÃªte avant 4." },
    ],
    "intermÃ©diaire": [
      { desc: "Que vaut sum(range(1, 6)) ?", answer: "15", hint: "range(1,6) = [1,2,3,4,5]. Somme = 15." },
      { desc: "Que retourne [i**2 for i in range(4)] ?", answer: "[0,1,4,9]", normalize: (a) => a.replace(/\s/g, ""), hint: "0Â²=0, 1Â²=1, 2Â²=4, 3Â²=9." },
      { desc: "Combien d'itÃ©rations : for i in range(0, 10, 3) ?", answer: "4", hint: "range(0,10,3) = [0,3,6,9] â†’ 4 valeurs." },
    ],
    "expert": [
      { desc: "Que retourne: list(zip([1,2,3], ['a','b','c']))[1] ?", answer: "(2,'b')", normalize: (a) => a.replace(/\s/g, "").replace(/"/g, "'"), hint: "zip crÃ©e des tuples. Index 1 = (2, 'b')." },
      { desc: "Que vaut: [x for x in range(10) if x%3==0 and x>0] ?", answer: "[3,6,9]", normalize: (a) => a.replace(/\s/g, ""), hint: "Multiples de 3 dans [1..9] : 3, 6, 9." },
      { desc: "Que retourne sum(1 for c in 'Hello World' if c.isupper()) ?", answer: "2", hint: "'H' et 'W' sont majuscules â†’ 2." },
    ],
  };

  const ch = pick(challenges[difficulty]);

  return {
    id: "loops",
    title: "BOUCLES & ITÃ‰RATIONS",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "Boucles for/while, range, comprehensions",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  run <code>      - Tester du Python           â•‘",
          "â•‘  explain         - Cours sur les boucles      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– BOUCLES PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "# For loop",
          "for i in range(5):      # 0,1,2,3,4",
          "    print(i)",
          "",
          "# While loop",
          "while x > 0:",
          "    x -= 1",
          "",
          "# List comprehension",
          "[x**2 for x in range(5)]  # [0,1,4,9,16]",
          "",
          "# range(start, stop, step)",
          "range(0, 10, 2)  # 0,2,4,6,8",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim();
        const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
        const expected = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
        if (norm === expected) return null;
        return [`âœ— Incorrect. RÃ©essayez.`];
      }
      if (input.startsWith("run ")) {
        const r = pyEval(input.slice(4));
        return r.error ? [`âœ— ${r.error}`] : [`>>> ${r.output}`];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim();
      const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
      const expected = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
      return norm === expected;
    },
    winResponse: [
      `âœ“ Correct ! RÃ©ponse : ${ch.answer}`,
      "",
      "âš  Ã€ RETENIR :",
      "â†’ range(n) : de 0 Ã  n-1.",
      "â†’ range(start, stop, step) pour plus de contrÃ´le.",
      "â†’ Les list comprehensions sont plus 'pythoniques' que les boucles.",
    ],
  };
};

const generateListsLevel = (difficulty) => {
  const challenges = {
    "dÃ©butant": [
      { desc: "lst = [10, 20, 30, 40]. Que vaut lst[2] ?", answer: "30", hint: "Les index commencent Ã  0 : lst[0]=10, lst[1]=20, lst[2]=30." },
      { desc: "lst = [1, 2, 3]. Que vaut len(lst) ?", answer: "3", hint: "len() retourne le nombre d'Ã©lÃ©ments." },
      { desc: "lst = [5, 3, 8, 1]. Que vaut sorted(lst) ? (format: [a,b,c,d])", answer: "[1,3,5,8]", normalize: (a) => a.replace(/\s/g, ""), hint: "sorted() trie par ordre croissant." },
    ],
    "intermÃ©diaire": [
      { desc: "lst = [1,2,3,4,5]. Que vaut lst[-2] ?", answer: "4", hint: "Index nÃ©gatifs : -1=dernier, -2=avant-dernier." },
      { desc: "lst = [1,2,3,4,5]. Que vaut lst[1:4] ? (format: [a,b,c])", answer: "[2,3,4]", normalize: (a) => a.replace(/\s/g, ""), hint: "Slicing : lst[start:stop] (stop exclu)." },
      { desc: "'hello'[::-1] retourne quoi ?", answer: "olleh", hint: "[::-1] inverse une sÃ©quence." },
    ],
    "expert": [
      { desc: "Que vaut: list(set([1,2,2,3,3,3])) triÃ© ?", answer: "[1,2,3]", normalize: (a) => a.replace(/\s/g, ""), hint: "set() supprime les doublons." },
      { desc: "Que retourne: dict(zip(['a','b'], [1,2])) ?", answer: "{'a':1,'b':2}", normalize: (a) => a.replace(/\s/g, "").replace(/"/g, "'"), hint: "zip + dict crÃ©e un dictionnaire." },
      { desc: "lst=[1,[2,3],[4,[5,6]]]. Que vaut lst[2][1][0] ?", answer: "5", hint: "lst[2]=[4,[5,6]], [1]=[5,6], [0]=5." },
    ],
  };

  const ch = pick(challenges[difficulty]);

  return {
    id: "lists",
    title: "LISTES & STRUCTURES",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "Listes, Slicing, MÃ©thodes",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  run <code>      - Tester du Python           â•‘",
          "â•‘  explain         - Cours sur les listes       â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– LISTES PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "lst = [1, 2, 3, 4, 5]",
          "lst[0]     â†’ 1        (premier)",
          "lst[-1]    â†’ 5        (dernier)",
          "lst[1:3]   â†’ [2, 3]   (slicing)",
          "lst[::-1]  â†’ [5,4,3,2,1] (inversÃ©)",
          "",
          "MÃ©thodes : append, insert, remove, pop, sort, reverse",
          "Fonctions : len, sorted, min, max, sum",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim();
        const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
        const expected = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
        if (norm === expected) return null;
        return [`âœ— Incorrect.`];
      }
      if (input.startsWith("run ")) { const r = pyEval(input.slice(4)); return r.error ? [`âœ— ${r.error}`] : [`>>> ${r.output}`]; }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim();
      const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
      const expected = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
      return norm === expected;
    },
    winResponse: [
      `âœ“ Correct ! ${ch.answer}`,
      "",
      "âš  Ã€ RETENIR :",
      "â†’ Index Ã  partir de 0, nÃ©gatifs depuis la fin.",
      "â†’ Slicing : lst[start:stop:step].",
      "â†’ Les listes sont mutables, les tuples non.",
    ],
  };
};

const generateFunctionsLevel = (difficulty) => {
  const challenges = {
    "dÃ©butant": [
      { desc: "ComplÃ©tez : def carre(x): return ___. Que met-on Ã  la place de ___ pour retourner x au carrÃ© ?", answer: "x**2", alt: ["x*x", "x ** 2", "x * x"], hint: "x au carrÃ© = x**2 ou x*x." },
      { desc: "def add(a, b): return a + b. Que retourne add(3, 7) ?", answer: "10", hint: "3 + 7 = 10." },
      { desc: "def greet(name): return 'Hello ' + name. Que retourne greet('Python') ?", answer: "hello python", normalize: (a) => a.toLowerCase().replace(/['"]/g, ""), hint: "'Hello ' + 'Python' = 'Hello Python'." },
    ],
    "intermÃ©diaire": [
      { desc: "def f(x, y=2): return x*y. Que retourne f(5) ?", answer: "10", hint: "y a une valeur par dÃ©faut de 2. f(5) = 5*2 = 10." },
      { desc: "def f(*args): return sum(args). Que retourne f(1,2,3,4) ?", answer: "10", hint: "*args capture tous les arguments. sum(1,2,3,4) = 10." },
      { desc: "Que retourne: (lambda x: x**3)(4) ?", answer: "64", hint: "Lambda x: xÂ³. 4Â³ = 64." },
    ],
    "expert": [
      { desc: "def f(n): return n * f(n-1) if n > 1 else 1. Que vaut f(5) ?", answer: "120", hint: "C'est la factorielle. 5! = 5Ã—4Ã—3Ã—2Ã—1 = 120." },
      { desc: "Que retourne: list(map(lambda x: x**2, filter(lambda x: x%2==0, range(6)))) ?", answer: "[0,4,16]", normalize: (a) => a.replace(/\s/g, ""), hint: "Pairs dans range(6): 0,2,4. CarrÃ©s: 0,4,16." },
      { desc: "def make_adder(n): return lambda x: x+n. f=make_adder(10). Que vaut f(5) ?", answer: "15", hint: "Closure : f = lambda x: x+10. f(5) = 15." },
    ],
  };

  const ch = pick(challenges[difficulty]);

  return {
    id: "functions",
    title: "FONCTIONS",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "Fonctions, Lambda, RÃ©cursion",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  run <code>      - Tester du Python           â•‘",
          "â•‘  explain         - Cours sur les fonctions    â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– FONCTIONS PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "def nom_fonction(param1, param2='dÃ©faut'):",
          "    '''Docstring'''",
          "    return rÃ©sultat",
          "",
          "# Lambda (fonction anonyme)",
          "carre = lambda x: x**2",
          "",
          "# *args et **kwargs",
          "def f(*args, **kwargs): ...",
          "",
          "# RÃ©cursion",
          "def fact(n): return n*fact(n-1) if n>1 else 1",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim();
        const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase().replace(/['"]/g, "");
        const expected = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
        const alts = ch.alt ? ch.alt.map((x) => x.toLowerCase()) : [];
        if (norm === expected || alts.includes(norm)) return null;
        return [`âœ— Incorrect.`];
      }
      if (input.startsWith("run ")) { const r = pyEval(input.slice(4)); return r.error ? [`âœ— ${r.error}`] : [`>>> ${r.output}`]; }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim();
      const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase().replace(/['"]/g, "");
      const expected = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
      const alts = ch.alt ? ch.alt.map((x) => x.toLowerCase()) : [];
      return norm === expected || alts.includes(norm);
    },
    winResponse: [
      `âœ“ Correct ! ${ch.answer}`,
      "",
      "âš  Ã€ RETENIR :",
      "â†’ def pour dÃ©finir, return pour retourner une valeur.",
      "â†’ Les paramÃ¨tres peuvent avoir des valeurs par dÃ©faut.",
      "â†’ Lambda = fonction courte et anonyme.",
    ],
  };
};

const generateStringsLevel = () => {
  const challenges = [
    { desc: "'Python'[2:5] retourne quoi ?", answer: "tho", hint: "Index 2='t', 3='h', 4='o'. Stop exclu." },
    { desc: "'hello world'.title() retourne quoi ?", answer: "hello world", normalize: (a) => a.replace(/['"]/g, ""), expected: "Hello World", hint: ".title() met chaque mot en majuscule." },
    { desc: "'  spaces  '.strip() retourne quoi ?", answer: "spaces", normalize: (a) => a.replace(/['"]/g, "").trim(), hint: ".strip() supprime les espaces en dÃ©but/fin." },
    { desc: "'a-b-c'.split('-') retourne quoi ?", answer: "['a','b','c']", normalize: (a) => a.replace(/\s/g, "").replace(/"/g, "'"), hint: ".split('-') coupe la chaÃ®ne Ã  chaque tiret." },
    { desc: "'-'.join(['x','y','z']) retourne quoi ?", answer: "x-y-z", normalize: (a) => a.replace(/['"]/g, ""), hint: ".join() assemble avec le sÃ©parateur." },
    { desc: "f'{3+4} est la rÃ©ponse' retourne quoi ?", answer: "7 est la rÃ©ponse", normalize: (a) => a.replace(/['"]/g, ""), hint: "f-string Ã©value les expressions entre {}." },
  ];

  const ch = pick(challenges);

  return {
    id: "strings",
    title: "STRINGS & MÃ‰THODES",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "ChaÃ®nes de caractÃ¨res, f-strings",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  run <code>      - Tester du Python           â•‘",
          "â•‘  explain         - Cours sur les strings      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– STRINGS PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "s = 'Hello World'",
          "s.upper()      â†’ 'HELLO WORLD'",
          "s.lower()      â†’ 'hello world'",
          "s.title()      â†’ 'Hello World'",
          "s.strip()      â†’ supprime espaces",
          "s.split(' ')   â†’ ['Hello', 'World']",
          "s.replace('o','0') â†’ 'Hell0 W0rld'",
          "s[0:5]         â†’ 'Hello'",
          "f'{nom} a {age} ans'  â†’ f-string",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim();
        const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
        const exp = ch.normalize ? ch.normalize(ch.expected || ch.answer) : (ch.expected || ch.answer).toLowerCase();
        if (norm === exp) return null;
        return [`âœ— Incorrect.`];
      }
      if (input.startsWith("run ")) { const r = pyEval(input.slice(4)); return r.error ? [`âœ— ${r.error}`] : [`>>> ${r.output}`]; }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim();
      const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
      const exp = ch.normalize ? ch.normalize(ch.expected || ch.answer) : (ch.expected || ch.answer).toLowerCase();
      return norm === exp;
    },
    winResponse: [
      `âœ“ Correct ! ${ch.expected || ch.answer}`,
      "",
      "âš  Ã€ RETENIR :",
      "â†’ Les strings sont immutables en Python.",
      "â†’ Les mÃ©thodes retournent une nouvelle chaÃ®ne.",
      "â†’ f-strings (f'...{expr}...') sont le format moderne.",
    ],
  };
};

const generateDictLevel = () => {
  const challenges = [
    { desc: "d = {'a': 1, 'b': 2, 'c': 3}. Que vaut d['b'] ?", answer: "2", hint: "d['b'] accÃ¨de Ã  la valeur associÃ©e Ã  la clÃ© 'b'." },
    { desc: "d = {'x': 10, 'y': 20}. Que retourne list(d.keys()) ?", answer: "['x','y']", normalize: (a) => a.replace(/\s/g, "").replace(/"/g, "'"), hint: ".keys() retourne les clÃ©s du dictionnaire." },
    { desc: "d = {'a': 1}. Que retourne d.get('z', 0) ?", answer: "0", hint: ".get(key, default) retourne default si la clÃ© n'existe pas." },
    { desc: "d = {'a': 1, 'b': 2}. Que vaut len(d) ?", answer: "2", hint: "len() compte le nombre de paires clÃ©-valeur." },
    { desc: "d = {1: 'a', 2: 'b'}. Que retourne list(d.values()) ?", answer: "['a','b']", normalize: (a) => a.replace(/\s/g, "").replace(/"/g, "'"), hint: ".values() retourne les valeurs." },
  ];

  const ch = pick(challenges);

  return {
    id: "dicts",
    title: "DICTIONNAIRES",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "Dictionnaires, MÃ©thodes",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  run <code>      - Tester du Python           â•‘",
          "â•‘  explain         - Cours sur les dicts        â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– DICTIONNAIRES PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "d = {'clÃ©': 'valeur', 'age': 25}",
          "d['clÃ©']        â†’ 'valeur'",
          "d.get('x', 0)   â†’ 0 (valeur par dÃ©faut)",
          "d.keys()        â†’ les clÃ©s",
          "d.values()      â†’ les valeurs",
          "d.items()       â†’ paires (clÃ©, valeur)",
          "d.update({...}) â†’ fusionner",
          "'clÃ©' in d      â†’ True/False",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim();
        const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
        const exp = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
        if (norm === exp) return null;
        return [`âœ— Incorrect.`];
      }
      if (input.startsWith("run ")) { const r = pyEval(input.slice(4)); return r.error ? [`âœ— ${r.error}`] : [`>>> ${r.output}`]; }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim();
      const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
      const exp = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
      return norm === exp;
    },
    winResponse: [`âœ“ Correct ! ${ch.answer}`, "", "âš  Ã€ RETENIR :", "â†’ Les clÃ©s doivent Ãªtre hashables (str, int, tuple).", "â†’ .get(key, default) Ã©vite les KeyError.", "â†’ Dict comprehension : {k: v for k, v in iterable}."],
  };
};

const generateErrorsLevel = () => {
  const challenges = [
    { desc: "print(10 / 0) provoque quelle erreur ?", answer: "zerodivisionerror", hint: "Division par zÃ©ro â†’ ZeroDivisionError." },
    { desc: "int('abc') provoque quelle erreur ?", answer: "valueerror", hint: "Conversion impossible â†’ ValueError." },
    { desc: "lst = [1,2]; lst[5] provoque quelle erreur ?", answer: "indexerror", hint: "Index hors limites â†’ IndexError." },
    { desc: "d = {}; d['x'] provoque quelle erreur ?", answer: "keyerror", hint: "ClÃ© inexistante â†’ KeyError." },
    { desc: "'hello' + 5 provoque quelle erreur ?", answer: "typeerror", hint: "ConcatÃ©nation str + int impossible â†’ TypeError." },
    { desc: "import blabla provoque quelle erreur ?", answer: "modulenotfounderror", hint: "Module inexistant â†’ ModuleNotFoundError." },
  ];

  const ch = pick(challenges);

  return {
    id: "errors",
    title: "GESTION D'ERREURS",
    mission: `${ch.desc} Tapez 'answer <NomErreur>'.`,
    hint: ch.hint,
    topic: "Exceptions, try/except",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <erreur>  - RÃ©pondre                  â•‘",
          "â•‘  errors           - Liste des erreurs Python  â•‘",
          "â•‘  explain          - Cours try/except          â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      errors: {
        response: [
          "ğŸ“‹ ERREURS PYTHON COURANTES :",
          "  SyntaxError         â†’ Erreur de syntaxe",
          "  TypeError           â†’ Mauvais type",
          "  ValueError          â†’ Mauvaise valeur",
          "  IndexError          â†’ Index hors limites",
          "  KeyError            â†’ ClÃ© inexistante",
          "  ZeroDivisionError   â†’ Division par zÃ©ro",
          "  AttributeError      â†’ Attribut inexistant",
          "  NameError           â†’ Variable non dÃ©finie",
          "  FileNotFoundError   â†’ Fichier introuvable",
          "  ModuleNotFoundError â†’ Module introuvable",
        ],
      },
      explain: {
        response: [
          "ğŸ“– TRY / EXCEPT",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "try:",
          "    rÃ©sultat = 10 / 0",
          "except ZeroDivisionError as e:",
          "    print(f'Erreur: {e}')",
          "except (TypeError, ValueError):",
          "    print('Type ou valeur incorrecte')",
          "else:",
          "    print('Pas d\\'erreur')",
          "finally:",
          "    print('Toujours exÃ©cutÃ©')",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim().toLowerCase();
        if (a === ch.answer) return null;
        return [`âœ— Ce n'est pas la bonne erreur. Tapez 'errors' pour la liste.`];
      }
      return null;
    },
    checkWin: (input) => input.startsWith("answer ") && input.slice(7).trim().toLowerCase() === ch.answer,
    winResponse: [`âœ“ Correct ! C'est bien un ${ch.answer.charAt(0).toUpperCase() + ch.answer.slice(1)}.`, "", "âš  Ã€ RETENIR :", "â†’ Toujours attraper les exceptions spÃ©cifiques, pas 'except:' seul.", "â†’ Le bloc 'finally' s'exÃ©cute dans tous les cas.", "â†’ EAFP (Easier to Ask Forgiveness) > LBYL en Python."],
  };
};

const generateOOPLevel = () => {
  const challenges = [
    { desc: "class Dog: def __init__(self, name): self.name = name. d = Dog('Rex'). Que vaut d.name ?", answer: "rex", normalize: (a) => a.replace(/['"]/g, "").toLowerCase(), hint: "self.name est initialisÃ© avec 'Rex'." },
    { desc: "Comment appelle-t-on la mÃ©thode __init__ d'une classe Python ?", answer: "constructeur", alt: ["constructor", "initialiseur", "initializer"], hint: "__init__ est le constructeur, appelÃ© Ã  la crÃ©ation de l'objet." },
    { desc: "class A: x=1. class B(A): x=2. Que vaut B().x ?", answer: "2", hint: "B surcharge x. L'hÃ©ritage donne prioritÃ© Ã  la classe enfant." },
    { desc: "Quel mot-clÃ© utilise-t-on pour hÃ©riter d'une classe en Python ?", answer: "class", alt: ["class b(a):", "parenthÃ¨ses", "()", "class b(a)"], hint: "class Enfant(Parent): â†’ les parenthÃ¨ses indiquent l'hÃ©ritage." },
  ];

  const ch = pick(challenges);

  return {
    id: "oop",
    title: "PROGRAMMATION OBJET",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "Classes, HÃ©ritage, OOP",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  explain         - Cours sur les classes      â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– CLASSES PYTHON",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "class Animal:",
          "    def __init__(self, nom):",
          "        self.nom = nom",
          "    def parler(self):",
          "        return f'{self.nom} fait du bruit'",
          "",
          "class Chien(Animal):       # HÃ©ritage",
          "    def parler(self):       # Override",
          "        return f'{self.nom} aboie'",
          "",
          "rex = Chien('Rex')",
          "rex.parler()  â†’ 'Rex aboie'",
          "",
          "Concepts : encapsulation, hÃ©ritage, polymorphisme",
          "MÃ©thodes spÃ©ciales : __init__, __str__, __repr__, __len__",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim();
        const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
        const exp = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
        const alts = ch.alt ? ch.alt.map((x) => x.toLowerCase()) : [];
        if (norm === exp || alts.includes(norm)) return null;
        return [`âœ— Incorrect.`];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim();
      const norm = ch.normalize ? ch.normalize(a) : a.toLowerCase();
      const exp = ch.normalize ? ch.normalize(ch.answer) : ch.answer.toLowerCase();
      const alts = ch.alt ? ch.alt.map((x) => x.toLowerCase()) : [];
      return norm === exp || alts.includes(norm);
    },
    winResponse: [`âœ“ Correct ! ${ch.answer}`, "", "âš  Ã€ RETENIR :", "â†’ __init__ initialise l'objet (constructeur).", "â†’ self = rÃ©fÃ©rence Ã  l'instance courante.", "â†’ L'hÃ©ritage : class Enfant(Parent)."],
  };
};

const generateDebugLevel = (difficulty) => {
  const bugs = {
    "dÃ©butant": [
      { code: ["def add(a, b)", "    return a + b"], error: "SyntaxError", fix: "Il manque les deux-points (:) aprÃ¨s la dÃ©finition.", answer: ":", alt: ["deux-points", "deux points", ": aprÃ¨s def"], hint: "En Python, les blocs commencent par ':'." },
      { code: ["x = 10", "if x = 10:", "    print('ok')"], error: "SyntaxError", fix: "Comparaison = vs ==.", answer: "==", alt: ["== au lieu de =", "double Ã©gal"], hint: "= est l'assignation, == est la comparaison." },
    ],
    "intermÃ©diaire": [
      { code: ["lst = [1, 2, 3]", "for i in range(len(lst)):", "    lst.append(i)"], error: "Boucle infinie", fix: "On modifie la liste pendant l'itÃ©ration.", answer: "boucle infinie", alt: ["infinite loop", "la liste grandit", "modification pendant itÃ©ration"], hint: "append() allonge la liste â†’ len(lst) ne s'arrÃªte jamais." },
      { code: ["d = {'a': 1}", "print(d['b'])"], error: "KeyError", fix: "La clÃ© 'b' n'existe pas.", answer: "keyerror", alt: ["key error", "clÃ© inexistante"], hint: "Utilisez d.get('b', default) pour Ã©viter le crash." },
    ],
    "expert": [
      { code: ["def f(lst=[]):", "    lst.append(1)", "    return lst", "print(f())", "print(f())"], error: "Bug: [1] puis [1,1]", fix: "Argument mutable par dÃ©faut partagÃ© entre appels.", answer: "mutable default", alt: ["argument mutable", "default mutable", "liste partagÃ©e", "mutable default argument"], hint: "Les arguments par dÃ©faut mutables sont partagÃ©s. Utilisez None." },
      { code: ["x = [1, 2, 3]", "y = x", "y.append(4)", "print(x)"], error: "x vaut [1,2,3,4]", fix: "y est une rÃ©fÃ©rence vers x, pas une copie.", answer: "[1,2,3,4]", alt: ["reference", "aliasing", "mÃªme objet", "1,2,3,4"], hint: "y = x ne copie pas. Utilisez y = x.copy() ou y = x[:]." },
    ],
  };

  const ch = pick(bugs[difficulty]);

  return {
    id: "debug",
    title: "DEBUGGING",
    mission: `Trouvez le bug dans ce code :\n${ch.code.map((l) => "  " + l).join("\n")}\n\nErreur : ${ch.error}. Tapez 'answer <explication>'.`,
    hint: ch.hint,
    topic: "Debugging, Erreurs courantes",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <fix>    - Expliquer le bug           â•‘",
          "â•‘  code            - Revoir le code             â•‘",
          "â•‘  explain         - Erreurs Python courantes   â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      code: {
        response: ["ğŸ“‹ CODE :", ...ch.code.map((l) => `  ${l}`), "", `Erreur : ${ch.error}`],
      },
      explain: {
        response: [
          "ğŸ“– BUGS PYTHON FRÃ‰QUENTS",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "â€¢ Oublier les : aprÃ¨s if/for/def/class",
          "â€¢ = (assignation) vs == (comparaison)",
          "â€¢ Modifier une liste pendant l'itÃ©ration",
          "â€¢ Argument mutable par dÃ©faut (def f(lst=[]))",
          "â€¢ Aliasing : y = x crÃ©e une rÃ©fÃ©rence, pas une copie",
          "â€¢ Off-by-one : range(n) va de 0 Ã  n-1",
          "â€¢ Indentation incorrecte",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim().toLowerCase();
        const expected = ch.answer.toLowerCase();
        const alts = ch.alt ? ch.alt.map((x) => x.toLowerCase()) : [];
        if (a === expected || alts.some((alt) => a.includes(alt) || alt.includes(a))) return null;
        return [`âœ— Pas exactement. Relisez le code et l'erreur.`];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim().toLowerCase();
      const expected = ch.answer.toLowerCase();
      const alts = ch.alt ? ch.alt.map((x) => x.toLowerCase()) : [];
      return a === expected || alts.some((alt) => a.includes(alt) || alt.includes(a));
    },
    winResponse: [`âœ“ Bug trouvÃ© !`, `  ${ch.fix}`, "", "âš  Ã€ RETENIR :", "â†’ Lire le traceback de bas en haut.", "â†’ Utiliser print() ou un debugger pour tracer.", "â†’ Les erreurs les plus sournoises : aliasing et mutable defaults."],
  };
};

const generateAlgoLevel = () => {
  const challenges = [
    { desc: "Quelle est la complexitÃ© de la recherche dans une liste triÃ©e avec la dichotomie (binary search) ?", answer: "o(log n)", alt: ["o(logn)", "log n", "logarithmique", "o(log(n))"], hint: "On divise par 2 Ã  chaque Ã©tape â†’ O(log n)." },
    { desc: "Quelle est la complexitÃ© du tri par sÃ©lection (selection sort) ?", answer: "o(n^2)", alt: ["o(nÂ²)", "o(n2)", "n carrÃ©", "quadratique", "n^2", "nÂ²"], hint: "Deux boucles imbriquÃ©es â†’ O(nÂ²)." },
    { desc: "Quel algorithme de tri utilise Python avec sorted() ?", answer: "timsort", alt: ["tim sort", "merge + insertion"], hint: "Timsort = hybride merge sort + insertion sort. InventÃ© par Tim Peters." },
    { desc: "Quelle structure utiliser pour vÃ©rifier si un Ã©lÃ©ment existe en O(1) ?", answer: "set", alt: ["dictionnaire", "dict", "hash", "hashset", "ensemble"], hint: "Les sets et dicts utilisent des tables de hachage â†’ lookup O(1)." },
  ];

  const ch = pick(challenges);

  return {
    id: "algo",
    title: "ALGORITHMES & COMPLEXITÃ‰",
    mission: `${ch.desc} Tapez 'answer <rÃ©ponse>'.`,
    hint: ch.hint,
    topic: "ComplexitÃ©, Tri, Recherche",
    commands: {
      help: {
        response: [
          "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
          "â•‘  answer <val>    - RÃ©pondre                   â•‘",
          "â•‘  explain         - Cours sur la complexitÃ©    â•‘",
          "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        ],
      },
      explain: {
        response: [
          "ğŸ“– COMPLEXITÃ‰ ALGORITHMIQUE",
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
          "O(1)       â†’ Constant (accÃ¨s dict/set)",
          "O(log n)   â†’ Logarithmique (binary search)",
          "O(n)       â†’ LinÃ©aire (parcours liste)",
          "O(n log n) â†’ Quasi-linÃ©aire (Timsort, mergesort)",
          "O(nÂ²)      â†’ Quadratique (tri bulle, sÃ©lection)",
          "O(2â¿)      â†’ Exponentiel (sous-ensembles)",
          "",
          "Python : sorted() utilise Timsort (O(n log n)).",
          "set/dict : lookup en O(1) grÃ¢ce au hachage.",
        ],
      },
    },
    defaultResponse: (input) => {
      if (input.startsWith("answer ")) {
        const a = input.slice(7).trim().toLowerCase();
        if (a === ch.answer || (ch.alt && ch.alt.some((x) => x.toLowerCase() === a))) return null;
        return [`âœ— Incorrect.`];
      }
      return null;
    },
    checkWin: (input) => {
      if (!input.startsWith("answer ")) return false;
      const a = input.slice(7).trim().toLowerCase();
      return a === ch.answer || (ch.alt && ch.alt.some((x) => x.toLowerCase() === a));
    },
    winResponse: [`âœ“ Correct ! ${ch.answer}`, "", "âš  Ã€ RETENIR :", "â†’ Toujours penser Ã  la complexitÃ© avant de coder.", "â†’ set/dict pour les lookups frÃ©quents.", "â†’ sorted() est O(n log n) â€” difficile de faire mieux."],
  };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PROFILES = {
  "dÃ©butant": {
    label: "ğŸŸ¢ DÃ‰BUTANT",
    desc: "LycÃ©en / DÃ©couverte â€” Bases Python",
    color: "#38bdf8",
    levels: () => [
      generateVariablesLevel(),
      generateConditionsLevel("dÃ©butant"),
      generateLoopsLevel("dÃ©butant"),
      generateListsLevel("dÃ©butant"),
      generateFunctionsLevel("dÃ©butant"),
      generateDebugLevel("dÃ©butant"),
    ],
  },
  "intermÃ©diaire": {
    label: "ğŸŸ¡ INTERMÃ‰DIAIRE",
    desc: "Ã‰tudiant Bac+2 â€” Python courant",
    color: "#facc15",
    levels: () => [
      generateVariablesLevel(),
      generateConditionsLevel("intermÃ©diaire"),
      generateLoopsLevel("intermÃ©diaire"),
      generateListsLevel("intermÃ©diaire"),
      generateStringsLevel(),
      generateDictLevel(),
      generateFunctionsLevel("intermÃ©diaire"),
      generateErrorsLevel(),
      generateDebugLevel("intermÃ©diaire"),
    ],
  },
  "expert": {
    label: "ğŸ”´ EXPERT",
    desc: "M1/M2 Dev â€” Python avancÃ©",
    color: "#f87171",
    levels: () => [
      generateConditionsLevel("expert"),
      generateLoopsLevel("expert"),
      generateListsLevel("expert"),
      generateStringsLevel(),
      generateDictLevel(),
      generateFunctionsLevel("expert"),
      generateOOPLevel(),
      generateErrorsLevel(),
      generateDebugLevel("expert"),
      generateAlgoLevel(),
    ],
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATRIX RAIN (Python themed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CodeRain = () => {
  const canvasRef = useRef(null);
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const resize = () => { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; };
    resize();
    const chars = "def:class()return import if else for in range print self lambda try except yield with as not and or True False None 0123456789 {} [] += -= == != <= >=";
    const fontSize = 13;
    const columns = Math.floor(canvas.width / fontSize);
    const drops = Array(columns).fill(1);
    const draw = () => {
      ctx.fillStyle = "rgba(0, 0, 0, 0.04)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.font = `${fontSize}px monospace`;
      for (let i = 0; i < drops.length; i++) {
        const c = chars[Math.floor(Math.random() * chars.length)];
        ctx.globalAlpha = Math.random() * 0.25 + 0.05;
        ctx.fillStyle = pick(["#38bdf8", "#facc15", "#4ade80", "#a78bfa"]);
        ctx.fillText(c, i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
      }
      ctx.globalAlpha = 1;
    };
    const interval = setInterval(draw, 55);
    window.addEventListener("resize", resize);
    return () => { clearInterval(interval); window.removeEventListener("resize", resize); };
  }, []);
  return <canvas ref={canvasRef} style={{ position: "absolute", top: 0, left: 0, width: "100%", height: "100%", opacity: 0.1, pointerEvents: "none" }} />;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function PythonGame() {
  const [screen, setScreen] = useState("menu");
  const [profile, setProfile] = useState(null);
  const [levels, setLevels] = useState([]);
  const [levelIdx, setLevelIdx] = useState(0);
  const [lines, setLines] = useState([]);
  const [input, setInput] = useState("");
  const [hintsUsed, setHintsUsed] = useState(0);
  const [startTime, setStartTime] = useState(null);
  const [playerName, setPlayerName] = useState("");
  const [leaderboard, setLeaderboard] = useState([]);
  const termRef = useRef(null);
  const inputRef = useRef(null);

  const scrollToBottom = useCallback(() => {
    if (termRef.current) setTimeout(() => { termRef.current.scrollTop = termRef.current.scrollHeight; }, 50);
  }, []);

  useEffect(() => { scrollToBottom(); }, [lines, scrollToBottom]);

  const startGame = (profileKey) => {
    const gen = PROFILES[profileKey].levels();
    setProfile(profileKey);
    setLevels(gen);
    setLevelIdx(0);
    setHintsUsed(0);
    setStartTime(Date.now());
    setLines([
      { type: "system", text: `â•â•â•â•â•â• NIVEAU 1/${gen.length} : ${gen[0].title} â•â•â•â•â•â•` },
      { type: "system", text: `ğŸ ${gen[0].topic}` },
      { type: "mission", text: gen[0].mission },
      { type: "empty", text: "" },
    ]);
    setScreen("game");
  };

  const addLines = (newLines, type = "response") => setLines((prev) => [...prev, ...newLines.map((text) => ({ type, text }))]);

  const advanceLevel = () => {
    if (levelIdx < levels.length - 1) {
      const next = levelIdx + 1;
      setLevelIdx(next);
      setTimeout(() => {
        addLines(["", `â•â•â•â•â•â• NIVEAU ${next + 1}/${levels.length} : ${levels[next].title} â•â•â•â•â•â•`, `ğŸ ${levels[next].topic}`], "system");
        addLines([levels[next].mission], "mission");
        addLines([""], "empty");
      }, 800);
    } else {
      setTimeout(() => setScreen("victory"), 1000);
    }
  };

  const handleCommand = (cmd) => {
    const original = cmd.trim();
    const trimmed = original.toLowerCase();
    if (!trimmed) return;
    setLines((prev) => [...prev, { type: "input", text: `>>> ${original}` }]);

    if (trimmed === "clear") { setLines([]); return; }
    if (trimmed === "mission") { addLines([levels[levelIdx].mission], "mission"); return; }
    if (trimmed === "hint") { setHintsUsed((h) => h + 1); addLines(["ğŸ’¡ " + levels[levelIdx].hint], "hint"); return; }
    if (trimmed === "score") {
      const e = Math.floor((Date.now() - startTime) / 1000);
      addLines([`Niveau: ${levelIdx + 1}/${levels.length} | Hints: ${hintsUsed} | Temps: ${Math.floor(e / 60)}m${String(e % 60).padStart(2, "0")}s`], "system");
      return;
    }

    const cl = levels[levelIdx];
    const proc = trimmed.startsWith("answer ") ? "answer " + original.slice(7) : trimmed;

    if (cl.checkWin && cl.checkWin(proc.toLowerCase())) { if (cl.winResponse) addLines(cl.winResponse, "success"); advanceLevel(); return; }
    if (cl.commands[trimmed]) { const r = cl.commands[trimmed]; addLines(r.response, "response"); return; }
    if (cl.defaultResponse) { const r = cl.defaultResponse(proc); if (r) { addLines(r, "response"); return; } }

    // Try as Python expression
    if (trimmed.startsWith("run ")) {
      const r = pyEval(original.slice(4));
      if (r.error) addLines([`âœ— ${r.error}`], "error");
      else addLines([`>>> ${r.output}`], "response");
      return;
    }

    addLines(["Commande non reconnue. Tapez 'help'."], "error");
  };

  const handleKeyDown = (e) => { if (e.key === "Enter") { handleCommand(input); setInput(""); } };
  const focusInput = () => inputRef.current?.focus();
  const getScore = () => {
    const e = Math.floor((Date.now() - startTime) / 1000);
    const base = { "dÃ©butant": 600, "intermÃ©diaire": 800, "expert": 1000 }[profile] || 600;
    return Math.max(0, base - hintsUsed * 50 - Math.floor(e / 15));
  };

  // â”€â”€â”€ MENU â”€â”€â”€
  if (screen === "menu") {
    return (
      <div style={{ minHeight: "100vh", background: "#0f172a", fontFamily: "'Fira Code','Cascadia Code',monospace", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", position: "relative", overflow: "hidden" }}>
        <CodeRain />
        <div style={{ zIndex: 10, textAlign: "center", maxWidth: "720px", padding: "20px" }}>
          <div style={{ color: "#475569", fontSize: "11px", letterSpacing: "8px", marginBottom: "16px" }}>Ã‰COLE IT VALENCIENNES</div>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: "12px", marginBottom: "6px" }}>
            <span style={{ fontSize: "42px" }}>ğŸ</span>
            <h1 style={{ color: "#38bdf8", fontSize: "36px", margin: 0, textShadow: "0 0 30px rgba(56,189,248,0.3)", letterSpacing: "3px" }}>PYTHON TERMINAL</h1>
          </div>
          <div style={{ color: "#64748b", fontSize: "13px", letterSpacing: "5px", marginBottom: "40px" }}>APPRENDRE EN CODANT</div>
          <div style={{ marginBottom: "30px" }}>
            <input value={playerName} onChange={(e) => setPlayerName(e.target.value)} placeholder="Votre pseudo (optionnel)" maxLength={20}
              style={{ background: "rgba(56,189,248,0.05)", border: "1px solid #1e3a5f", color: "#38bdf8", padding: "10px 16px", fontSize: "14px", fontFamily: "inherit", textAlign: "center", borderRadius: "4px", outline: "none", width: "250px" }}
              onFocus={(e) => e.target.style.borderColor = "#38bdf8"} onBlur={(e) => e.target.style.borderColor = "#1e3a5f"} />
          </div>
          <div style={{ color: "#94a3b8", fontSize: "13px", marginBottom: "24px", letterSpacing: "2px" }}>CHOISISSEZ VOTRE NIVEAU</div>
          <div style={{ display: "flex", gap: "16px", justifyContent: "center", flexWrap: "wrap" }}>
            {Object.entries(PROFILES).map(([key, p]) => (
              <button key={key} onClick={() => startGame(key)}
                style={{ background: "rgba(15,23,42,0.9)", border: `1px solid ${p.color}33`, color: p.color, padding: "20px 24px", fontFamily: "inherit", fontSize: "13px", cursor: "pointer", borderRadius: "6px", width: "200px", textAlign: "left", transition: "all 0.3s", boxShadow: `0 0 20px ${p.color}11` }}
                onMouseOver={(e) => { e.currentTarget.style.borderColor = p.color; e.currentTarget.style.boxShadow = `0 0 30px ${p.color}33`; }}
                onMouseOut={(e) => { e.currentTarget.style.borderColor = `${p.color}33`; e.currentTarget.style.boxShadow = `0 0 20px ${p.color}11`; }}>
                <div style={{ fontSize: "16px", marginBottom: "8px", fontWeight: "bold" }}>{p.label}</div>
                <div style={{ color: "#94a3b8", fontSize: "11px", lineHeight: "1.5" }}>{p.desc}</div>
                <div style={{ color: "#64748b", fontSize: "10px", marginTop: "8px" }}>{p.levels().length} niveaux â€¢ RandomisÃ©</div>
              </button>
            ))}
          </div>
          {leaderboard.length > 0 && (
            <div style={{ marginTop: "40px", maxWidth: "400px", margin: "40px auto 0" }}>
              <div style={{ color: "#facc15", fontSize: "12px", letterSpacing: "2px", marginBottom: "12px", textAlign: "left" }}>ğŸ† LEADERBOARD</div>
              {leaderboard.slice(0, 8).map((e, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", color: i === 0 ? "#facc15" : "#64748b", fontSize: "12px", padding: "4px 0", borderBottom: "1px solid #1e293b" }}>
                  <span>{i + 1}. {e.name}</span><span>{e.score} pts â€” {e.profile}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  // â”€â”€â”€ VICTORY â”€â”€â”€
  if (screen === "victory") {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const score = getScore();
    const p = PROFILES[profile];
    return (
      <div style={{ minHeight: "100vh", background: "#0f172a", fontFamily: "'Fira Code',monospace", display: "flex", alignItems: "center", justifyContent: "center", position: "relative", overflow: "hidden" }}>
        <CodeRain />
        <div style={{ zIndex: 10, textAlign: "center", padding: "50px", border: `1px solid ${p.color}44`, borderRadius: "8px", background: "rgba(15,23,42,0.95)", boxShadow: `0 0 60px ${p.color}15` }}>
          <div style={{ fontSize: "48px", marginBottom: "16px" }}>ğŸ†</div>
          <h1 style={{ color: p.color, fontSize: "26px", margin: "0 0 6px", letterSpacing: "4px" }}>MISSION ACCOMPLIE</h1>
          <div style={{ color: "#64748b", fontSize: "12px", letterSpacing: "3px", marginBottom: "30px" }}>{p.label}</div>
          <div style={{ color: "#94a3b8", marginBottom: "30px", lineHeight: "2.2", fontSize: "14px" }}>
            <div>Niveaux : <span style={{ color: p.color }}>{levels.length}/{levels.length}</span></div>
            <div>Temps : <span style={{ color: p.color }}>{Math.floor(elapsed / 60)}m {String(elapsed % 60).padStart(2, "0")}s</span></div>
            <div>Indices : <span style={{ color: hintsUsed === 0 ? "#4ade80" : "#facc15" }}>{hintsUsed}</span></div>
            <div style={{ fontSize: "22px", marginTop: "8px" }}>Score : <span style={{ color: p.color }}>{score}</span></div>
          </div>
          <div style={{ color: "#475569", fontSize: "11px", marginBottom: "24px", maxWidth: "380px", lineHeight: "1.6" }}>
            {levels.map((l) => l.topic).join(" Â· ")}
          </div>
          <div style={{ display: "flex", gap: "12px", justifyContent: "center", flexWrap: "wrap" }}>
            <button onClick={() => {
              setLeaderboard((prev) => [...prev, { name: playerName || "Anonyme", score, profile: p.label }].sort((a, b) => b.score - a.score));
              setScreen("menu");
            }} style={{ background: p.color, color: "#0f172a", border: "none", padding: "12px 28px", fontFamily: "inherit", fontSize: "13px", fontWeight: "bold", cursor: "pointer", letterSpacing: "2px", borderRadius: "3px" }}>
              SAUVER & MENU
            </button>
            <button onClick={() => startGame(profile)}
              style={{ background: "transparent", color: p.color, border: `1px solid ${p.color}`, padding: "12px 28px", fontFamily: "inherit", fontSize: "13px", cursor: "pointer", letterSpacing: "2px", borderRadius: "3px" }}>
              REJOUER
            </button>
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€â”€ GAME â”€â”€â”€
  const p = PROFILES[profile];
  return (
    <div style={{ minHeight: "100vh", background: "#0f172a", fontFamily: "'Fira Code',monospace", display: "flex", flexDirection: "column", position: "relative" }} onClick={focusInput}>
      <div style={{ background: "#1e293b", borderBottom: "1px solid #334155", padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "8px", zIndex: 10 }}>
        <div style={{ display: "flex", alignItems: "center", gap: "12px", flexWrap: "wrap" }}>
          <span style={{ color: p.color, fontSize: "13px", fontWeight: "bold" }}>ğŸ PYTHON TERMINAL</span>
          <span style={{ color: "#334155" }}>|</span>
          <span style={{ color: p.color, fontSize: "11px" }}>{p.label}</span>
          <span style={{ color: "#334155" }}>|</span>
          <span style={{ color: "#4ade80", fontSize: "11px" }}>{levels[levelIdx]?.title}</span>
        </div>
        <div style={{ display: "flex", gap: "10px", alignItems: "center" }}>
          {playerName && <span style={{ color: "#64748b", fontSize: "11px" }}>{playerName}</span>}
          <span style={{ color: "#64748b", fontSize: "11px" }}>LVL {levelIdx + 1}/{levels.length}</span>
          <div style={{ display: "flex", gap: "3px" }}>
            {levels.map((_, i) => (
              <div key={i} style={{ width: "7px", height: "7px", borderRadius: "50%", background: i < levelIdx ? "#4ade80" : i === levelIdx ? p.color : "#334155", boxShadow: i < levelIdx ? "0 0 4px #4ade80" : i === levelIdx ? `0 0 6px ${p.color}` : "none", transition: "all 0.3s" }} />
            ))}
          </div>
          <button onClick={() => setScreen("menu")} style={{ background: "none", border: "1px solid #334155", color: "#64748b", padding: "2px 8px", fontFamily: "inherit", fontSize: "10px", cursor: "pointer", borderRadius: "2px" }}>MENU</button>
        </div>
      </div>
      <div ref={termRef} style={{ flex: 1, overflowY: "auto", padding: "14px 16px", paddingBottom: "65px" }}>
        {lines.map((line, i) => {
          if (line.type === "empty") return <div key={i} style={{ height: "10px" }} />;
          const colors = { system: "#4ade80", input: "#e2e8f0", success: "#4ade80", error: "#f87171", hint: "#facc15", mission: "#38bdf8", response: "#94a3b8" };
          return <div key={i} style={{ color: colors[line.type] || "#94a3b8", fontSize: "13px", lineHeight: "1.7", whiteSpace: "pre-wrap", fontFamily: "inherit" }}>{line.text}</div>;
        })}
      </div>
      <div style={{ position: "fixed", bottom: 0, left: 0, right: 0, background: "#1e293b", borderTop: "1px solid #334155", padding: "10px 16px", display: "flex", alignItems: "center", gap: "8px", zIndex: 10 }}>
        <span style={{ color: p.color, fontSize: "14px" }}>â¯â¯â¯</span>
        <input ref={inputRef} value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKeyDown} autoFocus placeholder="Tapez une commande ou du Python..."
          style={{ flex: 1, background: "transparent", border: "none", outline: "none", color: "#e2e8f0", fontSize: "14px", fontFamily: "inherit", caretColor: p.color }} />
        <span style={{ color: "#334155", fontSize: "10px" }}>ENTER â†µ</span>
      </div>
    </div>
  );
}

        /* ----------------- */
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PythonGame />);
    </script>
</body>
</html>
